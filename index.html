<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />

  <title>GO Educação – Dashboard CS</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
  :root {
    --navy: #0A1A2F;
    --blue: #1F73B7;
    --yellow: #C8A300;
    --green: #2ECC71;
    --red: #CC3333;
    --orange: #FF7F0E;
    --gray-dark: #7A8194;
    --gray: #D8DCE8;
    --gray-light: #F5F6FA;
    --white: #FFFFFF;

    --radius: 12px;
  }

  * {
    box-sizing: border-box;
    font-family: system-ui, -apple-system, BlinkMacSystemFont,
      "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
    padding: 0;
  }

  body {
    background: var(--gray-light);
    color: var(--navy);
    padding: 0;
    margin: 0;
  }

  /* HEADER */
  header.topbar {
    background: linear-gradient(135deg, var(--navy), var(--blue));
    padding: 22px 28px;
    color: var(--white);
    box-shadow: 0 3px 8px rgba(0,0,0,0.20);
  }

  .topbar-inner {
    max-width: 1280px;
    margin: 0 auto;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    flex-wrap: wrap;
  }

  .topbar-title h1 {
    font-size: 24px;
    font-weight: 600;
    letter-spacing: 0.5px;
    margin: 0 0 4px;
  }

  .topbar-title span {
    font-size: 14px;
    opacity: 0.85;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    padding: 6px 12px;
    border-radius: 999px;
    background: rgba(255,255,255,0.15);
  }

  .dot {
    width: 9px;
    height: 9px;
    border-radius: 50%;
    background: #20c997;
  }

  /* LAYOUT PRINCIPAL (CONTAINER CENTRALIZADO) */
  main.container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 32px 24px 40px;
  }

  .loading {
    font-size: 13px;
    color: var(--gray-dark);
    margin-bottom: 16px;
  }

  .section {
    margin-top: 16px;
  }

  .section-title {
    font-size: 20px;
    font-weight: 600;
    margin: 32px 0 16px;
    color: var(--navy);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-title .icon {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    background: var(--yellow);
    display: inline-block;
  }

  /* KPI CARDS */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 18px;
    margin-bottom: 28px;
  }

  .kpi-card {
    background: var(--white);
    padding: 20px 22px;
    border-radius: var(--radius);
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid var(--gray);
  }

  .kpi-label {
    font-size: 12px;
    color: var(--gray-dark);
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .kpi-value {
    font-size: 30px;
    font-weight: 700;
    color: var(--navy);
    margin-bottom: 6px;
  }

  .kpi-extra {
    font-size: 13px;
    color: var(--gray-dark);
  }

  .kpi-tag {
    display: inline-block;
    margin-top: 8px;
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 999px;
  }

  .tag-ok {
    background: rgba(46, 204, 113, 0.15);
    color: var(--green);
  }

  .tag-warn {
    background: rgba(200,163,0,0.18);
    color: var(--yellow);
  }

  .tag-risk {
    background: rgba(204,51,51,0.18);
    color: var(--red);
  }

  /* PILLS GENÉRICAS */
  .pill {
    display: inline-block;
    padding: 4px 10px;
    font-size: 11px;
    border-radius: 999px;
    border: 1px solid var(--gray);
    background: var(--gray-light);
    color: var(--navy);
    margin-left: auto;
  }

  /* CARDS */
  .card {
    background: var(--white);
    padding: 22px;
    border-radius: var(--radius);
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid var(--gray);
  }

  .card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 16px;
    gap: 12px;
  }

  .card-title {
    font-size: 18px;
    font-weight: 600;
  }

  .card-subtitle {
    font-size: 13px;
    color: var(--gray-dark);
    margin-top: 2px;
  }

  /* GRIDS DE GRÁFICO */
  .charts-2col {
    display: grid;
    grid-template-columns: 1.7fr 1.3fr;
    gap: 22px;
    margin-top: 12px;
  }

  .charts-3col {
    display: grid;
    grid-template-columns: 1.2fr 1.2fr 1fr;
    gap: 22px;
    margin-top: 22px;
  }

  @media (max-width: 900px) {
    .charts-2col,
    .charts-3col {
      grid-template-columns: 1fr;
    }
  }

  /* TABELAS */
  table.table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
    font-size: 13px;
  }

  .table th {
    text-align: left;
    padding: 8px 6px;
    font-size: 11px;
    letter-spacing: 0.05em;
    color: var(--gray-dark);
    text-transform: uppercase;
    border-bottom: 1px solid var(--gray);
  }

  .table td {
    padding: 8px 6px;
    border-bottom: 1px solid #e7e9ef;
  }

  .link {
    cursor: pointer;
    color: var(--blue);
    text-decoration: underline;
    font-weight: 500;
  }

  /* MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
  }

  .modal-overlay.show {
    display: flex;
  }

  .modal {
    background: var(--white);
    padding: 26px;
    border-radius: var(--radius);
    width: 92%;
    max-width: 720px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 3px 20px rgba(0,0,0,0.25);
  }

  .modal-close {
    position: absolute;
    right: 14px;
    top: 10px;
    cursor: pointer;
    font-size: 22px;
    color: var(--gray-dark);
    border: none;
    background: transparent;
  }

  .modal-header {
    margin-bottom: 10px;
  }

  .modal-header h2 {
    font-size: 20px;
    margin-bottom: 4px;
  }

  .modal-header span {
    font-size: 13px;
    color: var(--gray-dark);
  }

  .modal-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-top: 16px;
  }

  @media (max-width: 650px) {
    .modal-grid {
      grid-template-columns: 1fr;
    }
  }

  .modal-block {
    background: var(--gray-light);
    padding: 14px;
    border-radius: var(--radius);
    font-size: 13px;
  }

  .modal-block h3 {
    font-size: 15px;
    margin-bottom: 6px;
    color: var(--navy);
  }

  /* FILTROS */
  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 12px;
    margin-top: 12px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .filter-group label {
    font-size: 11px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--gray-dark);
  }

  .filter-group select {
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid var(--gray);
    background: var(--white);
    font-size: 13px;
  }

  /* EXPERIENCE SUMMARY */
  #experience-summary {
    font-size: 13px;
    line-height: 1.45;
    margin-top: 6px;
    color: var(--gray-dark);
  }

  .exp-line {
    margin-bottom: 4px;
  }

  /* CHART CANVAS */
  canvas {
    width: 100% !important;
    max-height: 360px;
  }

  .mt-20 { margin-top: 20px; }
  .mt-30 { margin-top: 30px; }
  </style>
</head>
<body>
<header class="topbar">
  <div class="topbar-inner">
    <div class="topbar-title">
      <h1>GO Educação – Controle de Sucesso</h1>
      <span>Acompanhamento da jornada, prestação de contas e saúde da base</span>
    </div>

    <div class="badge">
      <span class="dot"></span>
      Dados carregados do Google Sheets
    </div>
  </div>
</header>

<main class="container">

  <div id="loading" class="loading">
    Carregando dados das 6 abas (Regras, Jornada, Prestação de Contas, Experience, Batalha Naval e Vendas)…
  </div>

  <!-- KPIs PRINCIPAIS -->
  <section class="section mt-20">
    <h2 class="section-title"><span class="icon"></span>Visão Geral</h2>

    <div class="kpi-grid">

      <div class="kpi-card">
        <div class="kpi-label">Alunos ativos</div>
        <div class="kpi-value" id="kpi-alunos-ativos">–</div>
        <div class="kpi-extra" id="kpi-alunos-ativos-extra"></div>
        <div class="kpi-tag tag-ok">Base atual da mentoria</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Taxa de sucesso da jornada</div>
        <div class="kpi-value" id="kpi-taxasucesso">–</div>
        <div class="kpi-extra" id="kpi-taxasucesso-extra"></div>
        <div class="kpi-tag tag-ok">Conclusão média da trilha</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Prestação de contas em dia</div>
        <div class="kpi-value" id="kpi-prestacao">–</div>
        <div class="kpi-extra" id="kpi-prestacao-extra"></div>
        <div class="kpi-tag tag-warn">Financeiro atualizado</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Potencial de Upsell</div>
        <div class="kpi-value" id="kpi-upsell">–</div>
        <div class="kpi-extra" id="kpi-upsell-extra"></div>
        <div class="kpi-tag tag-risk">Oportunidades comerciais</div>
      </div>

    </div>
  </section>

  <!-- FILTROS -->
  <section class="section mt-30">
    <h2 class="section-title"><span class="icon"></span>Filtros</h2>

    <div class="filters">
      <div class="filter-group">
        <label for="filtro-plano">Plano</label>
        <select id="filtro-plano">
          <option value="__all__">Todos os planos</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filtro-mes">Mês (Experience)</label>
        <select id="filtro-mes">
          <option value="__all__">Todos os meses</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filtro-encontro">Encontro</label>
        <select id="filtro-encontro">
          <option value="__all__">Todos os encontros</option>
        </select>
      </div>
    </div>
  </section>

  <!-- GRÁFICOS PRINCIPAIS -->
  <section class="section mt-30">
    <div class="charts-2col">

      <!-- Avanço da jornada -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Avanço da Jornada</div>
            <div class="card-subtitle">Percentual de conclusão por aluno (ordenado do maior para o menor).</div>
          </div>
          <span class="pill">Jornada</span>
        </div>

        <canvas id="chart-avanco"></canvas>
      </div>

      <!-- Risco de Churn -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Risco de Churn</div>
            <div class="card-subtitle">Distribuição da saúde da base.</div>
          </div>
          <span class="pill">Churn</span>
        </div>

        <canvas id="chart-churn"></canvas>
      </div>

    </div>
  </section>

  <!-- SEGUNDA LINHA DE GRÁFICOS -->
  <section class="section mt-30">
    <div class="charts-3col">

      <!-- Prestação de contas -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Prestação de Contas</div>
            <div class="card-subtitle">Status de envio por aluno.</div>
          </div>
          <span class="pill">Financeiro</span>
        </div>

        <canvas id="chart-prestacao"></canvas>
      </div>

      <!-- Batalha Naval / Upsell -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Batalha Naval</div>
            <div class="card-subtitle">Potencial comercial real (apenas “Potencial (R$)” da aba Batalha Naval).</div>
          </div>
          <span class="pill">Upsell</span>
        </div>

        <canvas id="chart-upsell"></canvas>
      </div>

      <!-- Experience resumo -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Let's GO Experience</div>
            <div class="card-subtitle">Engajamento total e filtrado por mês/encontro.</div>
          </div>
          <span class="pill">Experience</span>
        </div>

        <div id="experience-summary"></div>
      </div>

    </div>
  </section>

  <!-- TABELA – ALUNOS QUE PRECISAM ATENÇÃO -->
  <section class="section mt-30">
    <h2 class="section-title"><span class="icon"></span>Alunos que precisam de atenção</h2>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Prioridade de Ação</div>
          <div class="card-subtitle">
            Clique no nome para abrir o modal com informações completas.
          </div>
        </div>
        <span class="pill">CS</span>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Aluno</th>
            <th>Plano</th>
            <th>Avanço</th>
            <th>Prazo</th>
            <th>Risco</th>
            <th>Prestação</th>
            <th>Upsell</th>
          </tr>
        </thead>

        <tbody id="table-atencao"></tbody>
      </table>
    </div>
  </section>

  <!-- TABELA – ALUNOS ENCERRADOS -->
  <section class="section mt-30">
    <h2 class="section-title"><span class="icon"></span>Alunos Encerrados</h2>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Base encerrada da mentoria</div>
          <div class="card-subtitle">
            Clique no nome para ver o relatório individual.
          </div>
        </div>
        <span class="pill">Encerrados</span>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Aluno</th>
            <th>Plano</th>
            <th>Status</th>
            <th>Avanço</th>
            <th>Prestação</th>
            <th>Upsell</th>
          </tr>
        </thead>

        <tbody id="table-encerrados"></tbody>
      </table>
    </div>
  </section>

</main>

<!-- MODAL DO ALUNO -->
<div id="modal-overlay" class="modal-overlay">
  <div class="modal">
    <button class="modal-close" id="modal-close">&times;</button>
    <div id="modal-content"></div>
  </div>
</div>

<script>
/* URLs DAS 6 ABAS (EXATAMENTE COMO VOCÊ MANDOU) */
const URL_REGRAS     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=994652615&single=true&output=csv";
const URL_JORNADA    = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=3760243&single=true&output=csv";
const URL_PRESTACAO  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=997833295&single=true&output=csv";
const URL_EXPERIENCE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=0&single=true&output=csv";
const URL_BNAV       = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=569915638&single=true&output=csv";
const URL_VENDAS     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=1865445107&single=true&output=csv";

/* UTILITÁRIOS */
function normalize(s) {
  if (!s) return "";
  return s
    .toString()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .trim()
    .toLowerCase();
}

function parseNumberBR(v) {
  if (!v) return 0;
  v = v.toString();
  v = v.replace(/\s/g, "");
  v = v.replace(/\./g, "").replace(",", ".");
  const n = parseFloat(v);
  return isNaN(n) ? 0 : n;
}

function parsePercent(v) {
  if (!v) return 0;
  v = v.toString().replace("%", "").trim();
  return parseNumberBR(v);
}

/* CSV PARSER SIMPLES */
function parseCSV(text) {
  const lines = text.replace(/\r/g, "\n").split("\n").filter(l => l.trim() !== "");
  if (lines.length === 0) return [];

  const header = lines[0];

  const semis = (header.match(/;/g) || []).length;
  const commas = (header.match(/,/g) || []).length;
  const sep = semis > commas ? ";" : ",";

  const cols = header.split(sep).map(h => h.trim());
  const out = [];

  for (let i = 1; i < lines.length; i++) {
    const parts = lines[i].split(sep);
    const row = {};
    cols.forEach((c, idx) => (row[c] = (parts[idx] || "").trim()));
    out.push(row);
  }

  return out;
}

/* CARREGAMENTO DAS 6 ABAS */
async function loadAllCS() {
  const loading = document.getElementById("loading");
  loading.innerHTML = "Baixando dados…";

  const [REGRAS, JORNADA, PREST, EXP, BNAV, VEND] = await Promise.all([
    fetch(URL_REGRAS).then(r => r.text()),
    fetch(URL_JORNADA).then(r => r.text()),
    fetch(URL_PRESTACAO).then(r => r.text()),
    fetch(URL_EXPERIENCE).then(r => r.text()),
    fetch(URL_BNAV).then(r => r.text()),
    fetch(URL_VENDAS).then(r => r.text())
  ]);

  loading.innerHTML = "Convertendo CSV…";

  const regras     = parseCSV(REGRAS);
  const jornada    = parseCSV(JORNADA);
  const prest      = parseCSV(PREST);
  const experience = parseCSV(EXP);
  const bnav       = parseCSV(BNAV);
  const vendas     = parseCSV(VEND);

  loading.innerHTML = "Normalizando dados…";

  const base = normalizeAll({ regras, jornada, prest, experience, bnav, vendas });

  loading.innerHTML = "Gerando gráficos e tabelas…";

  renderAll(base);

  loading.style.display = "none";
}

/* NORMALIZAÇÃO PRINCIPAL */
function normalizeAll({ regras, jornada, prest, experience, bnav, vendas }) {
  /* Regras / Planos */
  const regrasMap = {};
  regras.forEach(r => {
    const planoRaw = r["Plano"] || "";
    const plano = normalize(planoRaw);
    if (!plano) return;
    regrasMap[plano] = {
      planoOriginal: planoRaw,
      prazo: r["Prazo (dias)"] ? parseInt(r["Prazo (dias)"]) : 0,
      valor: parseNumberBR(r["Valor"]),
      descricao: r["Descrição"] || ""
    };
  });

  /* Jornada do aluno */
  const jornadaMap = {};
  jornada.forEach(j => {
    const nomeBruto = j["Aluno"] || j["Cliente"] || "";
    const nomeNorm = normalize(nomeBruto);
    if (!nomeNorm) return;

    const planoBruto = j["Plano"] || "";
    const planoNorm = normalize(planoBruto);

    const percConclusao = parsePercent(j["Conclusão (%)"]);
    const percAvanco    = parsePercent(j["Avanço (%)"]);
    const progresso     = percConclusao || percAvanco;

    jornadaMap[nomeNorm] = {
      aluno: nomeBruto,
      plano: planoBruto,
      planoNorm,
      status: j["Status do plano"] || j["Status"] || "",
      risco: j["Risco de churn"] || j["Risco"] || "",
      prazo: j["Prazo"] || j["Prazo (dias)"] || "",
      progresso,
      dataInicio: j["Data início"] || j["Data início "] || "",
      dataFim: j["Data fim"] || j["Data fim "] || ""
    };
  });

  /* Prestação de contas */
  const prestMap = {};
  prest.forEach(p => {
    const nomeBruto = p["Aluno"] || p["Cliente"] || "";
    const nomeNorm = normalize(nomeBruto);
    if (!nomeNorm) return;

    const status = p["Status"] || "";
    const statusNorm = normalize(status);

    prestMap[nomeNorm] = {
      status,
      atualizado: statusNorm.includes("ok") || statusNorm.includes("em dia") ? 1 : 0
    };
  });

  /* Experience */
  const expMap = {};
  experience.forEach(e => {
    const nomeBruto = e["Aluno"] || e["Cliente"] || "";
    const nomeNorm = normalize(nomeBruto);
    if (!nomeNorm) return;

    if (!expMap[nomeNorm]) expMap[nomeNorm] = [];

    const presencaRaw = e["Presença"] || e["Presenca"] || e["Status presença"] || "";
    const presencaNorm = normalize(presencaRaw);

    expMap[nomeNorm].push({
      mes: e["Mês"] || e["Mes"] || "",
      encontro: e["Encontro"] || "",
      presenca: presencaNorm.includes("sim") || presencaNorm.includes("presente") ? 1 : 0
    });
  });

  /* Batalha Naval */
  const bnMap = {};
  bnav.forEach(b => {
    const nomeBruto = b["Aluno"] || b["Cliente"] || "";
    const nomeNorm = normalize(nomeBruto);
    if (!nomeNorm) return;

    bnMap[nomeNorm] = {
      potencial: parseNumberBR(b["Potencial (R$)"]),
      status: b["Status"] || "",
      observacao: b["Observação"] || b["Observacao"] || ""
    };
  });

  /* Vendas / Renovações */
  const vendMap = {};
  vendas.forEach(v => {
    const nomeBruto = v["Aluno"] || v["Cliente"] || "";
    const nomeNorm = normalize(nomeBruto);
    if (!nomeNorm) return;

    vendMap[nomeNorm] = {
      ultimaCompra: v["Data"] || "",
      produto: v["Produto"] || "",
      valor: parseNumberBR(v["Valor"])
    };
  });

  /* BASE FINAL */
  const alunos = Object.keys(jornadaMap);

  const baseFinal = alunos.map(n => {
    const j = jornadaMap[n];
    const p = prestMap[n] || {};
    const ex = expMap[n] || [];
    const bn = bnMap[n] || {};
    const vd = vendMap[n] || {};
    const rg = regrasMap[j.planoNorm] || {};

    return {
      nomeOriginal: j.aluno,
      nomeNorm: n,

      plano: j.plano,
      planoNorm: j.planoNorm,
      status: j.status,
      risco: j.risco,
      prazo: j.prazo,
      progresso: j.progresso || 0,
      dataInicio: j.dataInicio,
      dataFim: j.dataFim,

      prazoRegra: rg.prazo || 0,
      valorRegra: rg.valor || 0,

      prestStatus: p.status || "",
      prestAtualizado: p.atualizado || 0,

      experience: ex,

      potencial: bn.potencial || 0,
      bnStatus: bn.status || "",
      bnObs: bn.observacao || "",

      ultimaCompra: vd.ultimaCompra || "",
      produto: vd.produto || "",
      valorCompra: vd.valor || 0
    };
  });

  return baseFinal;
}

/* RENDERIZAÇÃO GERAL */
let CS_BASE = [];
let chartAvanco = null;
let chartChurn = null;
let chartPrest = null;
let chartUpsell = null;

function renderAll(base) {
  CS_BASE = base;

  popularFiltros(base);
  buildKPIs(base);
  buildExperienceSummary(base);
  buildChartAvanco(base);
  buildChartChurn(base);
  buildChartPrestacao(base);
  buildChartUpsell(base);
  buildTables(base);
  setupModal();

  // listeners dos filtros
  document.getElementById("filtro-plano").addEventListener("change", () => aplicarFiltros());
  document.getElementById("filtro-mes").addEventListener("change", () => aplicarFiltros());
  document.getElementById("filtro-encontro").addEventListener("change", () => aplicarFiltros());
}

/* FILTROS – POPULAR COM BASE NOS DADOS */
function popularFiltros(base) {
  const selPlano = document.getElementById("filtro-plano");
  const selMes   = document.getElementById("filtro-mes");
  const selEn    = document.getElementById("filtro-encontro");

  const planos = new Set();
  const meses  = new Set();
  const encs   = new Set();

  base.forEach(a => {
    if (a.plano) planos.add(a.plano);
    (a.experience || []).forEach(e => {
      if (e.mes) meses.add(e.mes);
      if (e.encontro) encs.add(e.encontro);
    });
  });

  [...planos].sort().forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    selPlano.appendChild(opt);
  });

  [...meses].sort().forEach(m => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    selMes.appendChild(opt);
  });

  [...encs].sort().forEach(e => {
    const opt = document.createElement("option");
    opt.value = e;
    opt.textContent = e;
    selEn.appendChild(opt);
  });
}

/* APLICAÇÃO DOS FILTROS NA BASE */
function getBaseFiltrada() {
  const planoSel = document.getElementById("filtro-plano").value;
  const mesSel   = document.getElementById("filtro-mes").value;
  const encSel   = document.getElementById("filtro-encontro").value;

  let base = [...CS_BASE];

  if (planoSel !== "__all__") {
    base = base.filter(a => a.plano === planoSel);
  }

  // filtros de Experience são usados principalmente no resumo,
  // mas vamos manter a base geral para gráficos/tabelas
  return { base, planoSel, mesSel, encSel };
}

function aplicarFiltros() {
  const { base, mesSel, encSel } = getBaseFiltrada();

  buildKPIs(base);
  buildChartAvanco(base);
  buildChartChurn(base);
  buildChartPrestacao(base);
  buildChartUpsell(base);
  buildTables(base);
  buildExperienceSummary(base, mesSel, encSel);
}

/* KPIs */
function buildKPIs(base) {
  if (!base.length) return;

  const ativos = base.filter(a => !normalize(a.status).includes("encerr")).length;
  const encerrados = base.length - ativos;

  document.getElementById("kpi-alunos-ativos").textContent = ativos;
  document.getElementById("kpi-alunos-ativos-extra").textContent =
    encerrados + " encerrados";

  const mediaConclusao =
    base.reduce((sum, a) => sum + (a.progresso || 0), 0) / base.length;

  document.getElementById("kpi-taxasucesso").textContent =
    mediaConclusao.toFixed(1) + "%";
  document.getElementById("kpi-taxasucesso-extra").textContent =
    "Média geral da trilha";

  const prestOK = base.filter(a => a.prestAtualizado === 1).length;
  const prestPerc = (prestOK / base.length) * 100;

  document.getElementById("kpi-prestacao").textContent =
    prestPerc.toFixed(1) + "%";
  document.getElementById("kpi-prestacao-extra").textContent =
    prestOK + " de " + base.length + " atualizaram";

  const totalUpsell = base.reduce((sum, a) => sum + (a.potencial || 0), 0);

  document.getElementById("kpi-upsell").textContent =
    "R$ " + totalUpsell.toLocaleString("pt-BR");
  document.getElementById("kpi-upsell-extra").textContent =
    "Potencial total só da aba Batalha Naval";
}

/* EXPERIENCE SUMMARY (considera filtros de mês e encontro) */
function buildExperienceSummary(base, mesSel, encSel) {
  const container = document.getElementById("experience-summary");
  if (!base.length) {
    container.textContent = "Sem dados de Experience.";
    return;
  }

  const mesFiltro = mesSel || document.getElementById("filtro-mes").value;
  const encFiltro = encSel || document.getElementById("filtro-encontro").value;

  let totalRegistros = 0;
  let totalPresenca  = 0;

  base.forEach(a => {
    (a.experience || []).forEach(e => {
      if (mesFiltro !== "__all__" && e.mes !== mesFiltro) return;
      if (encFiltro !== "__all__" && e.encontro !== encFiltro) return;
      totalRegistros++;
      if (e.presenca === 1) totalPresenca++;
    });
  });

  if (totalRegistros === 0) {
    container.textContent = "Não há registros para os filtros selecionados.";
    return;
  }

  const taxa = (totalPresenca / totalRegistros) * 100;

  container.innerHTML = `
    <div class="exp-line"><strong>Registros considerados:</strong> ${totalRegistros}</div>
    <div class="exp-line"><strong>Presenças:</strong> ${totalPresenca}</div>
    <div class="exp-line"><strong>Taxa de participação:</strong> ${taxa.toFixed(1)}%</div>
    <div class="exp-line">
      <strong>Filtro ativo:</strong>
      Mês = ${mesFiltro === "__all__" ? "Todos" : mesFiltro},
      Encontro = ${encFiltro === "__all__" ? "Todos" : encFiltro}
    </div>
  `;
}

/* GRÁFICO – AVANÇO JORNADA */
function buildChartAvanco(base) {
  const ctx = document.getElementById("chart-avanco");
  if (!ctx) return;

  if (chartAvanco) {
    chartAvanco.destroy();
    chartAvanco = null;
  }

  const ordenado = [...base].sort((a, b) => (b.progresso || 0) - (a.progresso || 0));

  const labels = ordenado.map(a => a.nomeOriginal);
  const data   = ordenado.map(a => a.progresso || 0);

  chartAvanco = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "Conclusão (%)",
          data,
          borderWidth: 0,
          backgroundColor: "#1F73B7"
        }
      ]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { max: 100 }
      }
    }
  });
}

/* GRÁFICO – RISCO DE CHURN */
function buildChartChurn(base) {
  const ctx = document.getElementById("chart-churn");
  if (!ctx) return;

  if (chartChurn) {
    chartChurn.destroy();
    chartChurn = null;
  }

  const counts = {
    saudavel: 0,
    moderado: 0,
    alto: 0,
    encerrado: 0,
    alerta: 0,
    outros: 0
  };

  base.forEach(a => {
    const r = normalize(a.risco);
    if (!r) {
      counts.outros++;
    } else if (r.includes("saud")) {
      counts.saudavel++;
    } else if (r.includes("moder")) {
      counts.moderado++;
    } else if (r.includes("alto")) {
      counts.alto++;
    } else if (r.includes("encerr")) {
      counts.encerrado++;
    } else if (r.includes("alert")) {
      counts.alerta++;
    } else {
      counts.outros++;
    }
  });

  chartChurn = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: [
        "Saudável",
        "Moderado",
        "Alto",
        "Encerrado",
        "Alerta",
        "Outros"
      ],
      datasets: [
        {
          data: [
            counts.saudavel,
            counts.moderado,
            counts.alto,
            counts.encerrado,
            counts.alerta,
            counts.outros
          ],
          backgroundColor: [
            "#2ECC71",
            "#C8A300",
            "#CC3333",
            "#1F73B7",
            "#FF7F0E",
            "#7A8194"
          ]
        }
      ]
    },
    options: {
      responsive: true,
      cutout: "55%",
      plugins: {
        legend: { position: "bottom" }
      }
    }
  });
}

/* GRÁFICO – PRESTAÇÃO DE CONTAS */
function buildChartPrestacao(base) {
  const ctx = document.getElementById("chart-prestacao");
  if (!ctx) return;

  if (chartPrest) {
    chartPrest.destroy();
    chartPrest = null;
  }

  let ok = 0, pend = 0;

  base.forEach(a => {
    if (a.prestAtualizado === 1) ok++;
    else pend++;
  });

  chartPrest = new Chart(ctx, {
    type: "pie",
    data: {
      labels: ["Atualizado", "Pendente"],
      datasets: [
        {
          data: [ok, pend],
          backgroundColor: ["#2ECC71", "#CC3333"]
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" }
      }
    }
  });
}

/* GRÁFICO – UPSALE / BATALHA NAVAL */
function buildChartUpsell(base) {
  const ctx = document.getElementById("chart-upsell");
  if (!ctx) return;

  if (chartUpsell) {
    chartUpsell.destroy();
    chartUpsell = null;
  }

  // Apenas quem tem potencial > 0
  const comPotencial = base.filter(a => (a.potencial || 0) > 0);
  const ordenado = [...comPotencial].sort((a, b) => (b.potencial || 0) - (a.potencial || 0));

  const labels = ordenado.map(a => a.nomeOriginal);
  const data   = ordenado.map(a => a.potencial || 0);

  chartUpsell = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "Potencial (R$)",
          data,
          backgroundColor: "#C8A300"
        }
      ]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: {
          ticks: {
            callback: function(value) {
              return "R$ " + value.toLocaleString("pt-BR");
            }
          }
        }
      }
    }
  });
}

/* TABELAS */
function buildTables(base) {
  const tbodyA = document.getElementById("table-atencao");
  const tbodyE = document.getElementById("table-encerrados");

  tbodyA.innerHTML = "";
  tbodyE.innerHTML = "";

  base.forEach(a => {
    const linha = `
      <tr>
        <td><span class="link" onclick="openModal('${a.nomeNorm}')">${a.nomeOriginal}</span></td>
        <td>${a.plano || "-"}</td>
        <td>${(a.progresso || 0).toFixed(0)}%</td>
        <td>${a.prazo || "-"}</td>
        <td>${a.risco || "-"}</td>
        <td>${a.prestStatus || "-"}</td>
        <td>R$ ${(a.potencial || 0).toLocaleString("pt-BR")}</td>
      </tr>
    `;

    if (normalize(a.status).includes("encerr")) {
      tbodyE.insertAdjacentHTML("beforeend", linha);
    } else {
      tbodyA.insertAdjacentHTML("beforeend", linha);
    }
  });
}

/* MODAL */
function setupModal() {
  const overlay = document.getElementById("modal-overlay");
  const closeBtn = document.getElementById("modal-close");

  closeBtn.addEventListener("click", () => {
    overlay.classList.remove("show");
  });

  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) {
      overlay.classList.remove("show");
    }
  });
}

function openModal(nomeNorm) {
  const a = CS_BASE.find(x => x.nomeNorm === nomeNorm);
  if (!a) return;

  const modalContent = document.getElementById("modal-content");

  const presencas = (a.experience || []).filter(e => e.presenca === 1).length;
  const totalExp  = (a.experience || []).length;

  const txExp = totalExp > 0 ? ((presencas / totalExp) * 100).toFixed(1) + "%" : "-";

  modalContent.innerHTML = `
    <div class="modal-header">
      <h2>${a.nomeOriginal}</h2>
      <span>${a.plano || ""}</span>
    </div>

    <div class="modal-grid">
      <div class="modal-block">
        <h3>Jornada</h3>
        <p><b>Status do plano:</b> ${a.status || "-"}</p>
        <p><b>Conclusão:</b> ${(a.progresso || 0).toFixed(1)}%</p>
        <p><b>Risco de churn:</b> ${a.risco || "-"}</p>
        <p><b>Prazo:</b> ${a.prazo || "-"}</p>
        <p><b>Início:</b> ${a.dataInicio || "-"}</p>
        <p><b>Fim:</b> ${a.dataFim || "-"}</p>
      </div>

      <div class="modal-block">
        <h3>Financeiro & Upsell</h3>
        <p><b>Prestação de contas:</b> ${a.prestStatus || "-"}</p>
        <p><b>Potencial Batalha Naval:</b> R$ ${(a.potencial || 0).toLocaleString("pt-BR")}</p>
        <p><b>Última compra:</b> ${a.ultimaCompra || "-"}</p>
        <p><b>Produto:</b> ${a.produto || "-"}</p>
        <p><b>Valor última compra:</b> R$ ${(a.valorCompra || 0).toLocaleString("pt-BR")}</p>
        <p><b>Engajamento Experience:</b> ${txExp}</p>
      </div>
    </div>
  `;

  document.getElementById("modal-overlay").classList.add("show");
}

/* START */
loadAllCS();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>GO Educa√ß√£o ‚Äì Dashboard CS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ----------------------------------------------------------
       VARI√ÅVEIS / BASE DE DESIGN
       ---------------------------------------------------------- */
    :root {
      --navy: #0A1A2F;
      --blue: #1F73B7;
      --yellow: #C8A300;
      --green: #2ECC71;
      --red: #CC3333;
      --orange: #FF7F0E;
      --gray-dark: #7A8194;
      --gray: #D8DCE8;
      --gray-light: #F5F6FA;
      --white: #FFFFFF;

      --radius: 12px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--gray-light);
      color: var(--navy);
      padding: 0;
      margin: 0;
    }

    /* ----------------------------------------------------------
       HEADER / TOPO
       ---------------------------------------------------------- */
    header.topbar {
      background: linear-gradient(135deg, var(--navy), var(--blue));
      padding: 22px 28px;
      color: var(--white);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }

    .topbar-inner {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .topbar-title h1 {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .topbar-title span {
      font-size: 14px;
      opacity: 0.9;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      background: rgba(255, 255, 255, 0.14);
      padding: 6px 12px;
      border-radius: 999px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #20c997;
    }

    /* ----------------------------------------------------------
       LAYOUT PRINCIPAL
       ---------------------------------------------------------- */
    main.container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 32px 24px 40px;
    }

    .section {
      margin-top: 24px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--navy);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title .icon {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      background: var(--yellow);
      display: inline-block;
    }

    .loading {
      font-size: 13px;
      color: var(--gray-dark);
    }

    .mt-20 { margin-top: 20px; }
    .mt-30 { margin-top: 30px; }

    /* ----------------------------------------------------------
       KPI CARDS
       ---------------------------------------------------------- */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 18px;
      margin-bottom: 12px;
    }

    .kpi-card {
      background: var(--white);
      padding: 20px 22px;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid var(--gray);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .kpi-label {
      font-size: 12px;
      color: var(--gray-dark);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .kpi-value {
      font-size: 30px;
      font-weight: 700;
      color: var(--navy);
    }

    .kpi-extra {
      font-size: 13px;
      color: var(--gray-dark);
    }

    .kpi-tag {
      margin-top: 4px;
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
    }

    .tag-ok {
      background: rgba(46, 204, 113, 0.14);
      color: var(--green);
    }

    .tag-warn {
      background: rgba(200, 163, 0, 0.16);
      color: var(--yellow);
    }

    .tag-risk {
      background: rgba(204, 51, 51, 0.16);
      color: var(--red);
    }

    /* ----------------------------------------------------------
       CARDS / GRIDS
       ---------------------------------------------------------- */
    .card {
      background: var(--white);
      padding: 22px;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid var(--gray);
    }

    .card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 12px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--gray-dark);
      margin-top: 2px;
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid var(--gray);
      background: var(--gray-light);
      color: var(--navy);
    }

    .charts-2col {
      display: grid;
      grid-template-columns: 1.6fr 1.2fr;
      gap: 22px;
    }

    .charts-3col {
      display: grid;
      grid-template-columns: 1.2fr 1.2fr 1fr;
      gap: 22px;
    }

    @media (max-width: 900px) {
      .charts-2col,
      .charts-3col {
        grid-template-columns: 1fr;
      }
    }

    /* ----------------------------------------------------------
       FILTROS
       ---------------------------------------------------------- */
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-group label {
      font-size: 11px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--gray-dark);
    }

    .filter-group select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--gray);
      background: var(--white);
      font-size: 13px;
    }

    /* ----------------------------------------------------------
       TABELAS
       ---------------------------------------------------------- */
    table.table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }

    .table th {
      text-align: left;
      padding: 8px 6px;
      font-size: 11px;
      letter-spacing: 0.05em;
      color: var(--gray-dark);
      text-transform: uppercase;
      border-bottom: 1px solid var(--gray);
    }

    .table td {
      padding: 8px 6px;
      border-bottom: 1px solid #e7e9ef;
    }

    .link-aluno {
      cursor: pointer;
      color: var(--blue);
      text-decoration: underline;
      font-weight: 500;
    }

    /* ----------------------------------------------------------
       EXPERIENCE SUMMARY
       ---------------------------------------------------------- */
    #experience-summary {
      font-size: 13px;
      color: var(--gray-dark);
      line-height: 1.45;
    }

    .exp-line {
      margin-bottom: 4px;
    }

    /* ----------------------------------------------------------
       MODAL
       ---------------------------------------------------------- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--white);
      padding: 26px;
      border-radius: var(--radius);
      width: 92%;
      max-width: 720px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 3px 20px rgba(0, 0, 0, 0.25);
    }

    .modal-close {
      position: absolute;
      right: 14px;
      top: 10px;
      cursor: pointer;
      font-size: 22px;
      color: var(--gray-dark);
      border: none;
      background: transparent;
    }

    .modal-header {
      margin-bottom: 12px;
    }

    .modal-header h2 {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .modal-header span {
      font-size: 13px;
      color: var(--gray-dark);
    }

    .modal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    @media (max-width: 650px) {
      .modal-grid {
        grid-template-columns: 1fr;
      }
    }

    .modal-block {
      background: var(--gray-light);
      padding: 14px;
      border-radius: var(--radius);
      font-size: 13px;
    }

    .modal-block h3 {
      font-size: 15px;
      margin-bottom: 6px;
      color: var(--navy);
    }

    .hidden {
      display: none !important;
    }

    canvas {
      width: 100% !important;
      max-height: 360px;
    }
  </style>
</head>
<body>
<header class="topbar">
  <div class="topbar-inner">
    <div class="topbar-title">
      <h1>GO Educa√ß√£o ‚Äì Controle de Sucesso</h1>
      <span>Acompanhamento da jornada, presta√ß√£o de contas e sa√∫de da base</span>
    </div>
    <div class="badge">
      <span class="dot"></span>
      Dados carregados do Google Sheets
    </div>
  </div>
</header>

<main class="container">
  <div id="loading" class="loading">
    Carregando dados das 6 abas (Regras/Planos, Jornada, Presta√ß√£o de Contas,
    Experience, Batalha Naval e Vendas)‚Ä¶
  </div>

  <!-- KPIs -->
  <section class="section mt-20">
    <h2 class="section-title"><span class="icon"></span>Vis√£o geral</h2>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Alunos ativos</div>
        <div class="kpi-value" id="kpi-alunos-ativos">‚Äì</div>
        <div class="kpi-extra" id="kpi-alunos-ativos-extra"></div>
        <div class="kpi-tag tag-ok">Base atual da mentoria</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Taxa de sucesso da jornada</div>
        <div class="kpi-value" id="kpi-taxasucesso">‚Äì</div>
        <div class="kpi-extra" id="kpi-taxasucesso-extra"></div>
        <div class="kpi-tag tag-ok">Conclus√£o m√©dia da trilha</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Presta√ß√£o de contas em dia</div>
        <div class="kpi-value" id="kpi-prestacao">‚Äì</div>
        <div class="kpi-extra" id="kpi-prestacao-extra"></div>
        <div class="kpi-tag tag-warn">Financeiro atualizado</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Potencial de upsell</div>
        <div class="kpi-value" id="kpi-upsell">‚Äì</div>
        <div class="kpi-extra" id="kpi-upsell-extra"></div>
        <div class="kpi-tag tag-risk">Oportunidades comerciais</div>
      </div>
    </div>
  </section>

  <!-- Filtros b√°sicos (opcional para futuro) -->
  <section class="section mt-30">
    <h2 class="section-title"><span class="icon"></span>Filtros (vis√£o geral)</h2>
    <div class="filters">
      <div class="filter-group">
        <label for="filtro-plano">Plano</label>
        <select id="filtro-plano">
          <option value="__all__">Todos os planos</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filtro-mes">M√™s (Experience)</label>
        <select id="filtro-mes">
          <option value="__all__">Todos os meses</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filtro-encontro">Encontro</label>
        <select id="filtro-encontro">
          <option value="__all__">Todos os encontros</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Gr√°ficos principais -->
  <section class="section mt-30">
    <div class="charts-2col">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Avan√ßo da jornada</div>
            <div class="card-subtitle">
              Percentual de conclus√£o por aluno (foco nos ativos).
            </div>
          </div>
          <span class="pill">Jornada</span>
        </div>
        <canvas id="chart-avanco"></canvas>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Distribui√ß√£o de risco de churn</div>
            <div class="card-subtitle">
              Classifica√ß√£o da sa√∫de da base por risco.
            </div>
          </div>
          <span class="pill">Churn</span>
        </div>
        <canvas id="chart-churn"></canvas>
      </div>
    </div>
  </section>

  <!-- Segunda linha de gr√°ficos -->
  <section class="section mt-30">
    <div class="charts-3col">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Presta√ß√£o de contas</div>
            <div class="card-subtitle">
              Status de envio por aluno (OK x pendente).
            </div>
          </div>
          <span class="pill">Financeiro</span>
        </div>
        <canvas id="chart-prestacao"></canvas>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Batalha Naval</div>
            <div class="card-subtitle">
              Potencial comercial usando <strong>Oportunidade total por aluno</strong>.
            </div>
          </div>
          <span class="pill">Upsell</span>
        </div>
        <canvas id="chart-upsell"></canvas>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Let's GO Experience</div>
            <div class="card-subtitle">
              Engajamento geral (presen√ßa nos encontros).
            </div>
          </div>
          <span class="pill">Experience</span>
        </div>
        <div id="experience-summary"></div>
      </div>
    </div>
  </section>

  <!-- Alunos que precisam de aten√ß√£o -->
  <section class="section mt-30">
    <h2 class="section-title"><span class="icon"></span>Alunos que precisam de aten√ß√£o</h2>
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Prioridade de a√ß√£o</div>
          <div class="card-subtitle">
            Clique no nome para abrir o modal com vis√£o individual.
          </div>
        </div>
        <span class="pill">CS</span>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Aluno</th>
            <th>Plano</th>
            <th>Avan√ßo</th>
            <th>Prazo</th>
            <th>Risco</th>
            <th>Presta√ß√£o</th>
            <th>Upsell</th>
          </tr>
        </thead>
        <tbody id="table-atencao"></tbody>
      </table>
    </div>
  </section>

  <!-- Alunos encerrados -->
  <section class="section mt-30">
    <h2 class="section-title"><span class="icon"></span>Alunos encerrados</h2>
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Base encerrada da mentoria</div>
          <div class="card-subtitle">
            Clique no nome para ver o relat√≥rio individual.
          </div>
        </div>
        <span class="pill">Encerrados</span>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Aluno</th>
            <th>Plano</th>
            <th>Status</th>
            <th>Avan√ßo</th>
            <th>Presta√ß√£o</th>
            <th>Upsell</th>
          </tr>
        </thead>
        <tbody id="table-encerrados"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Modal -->
<div id="modal-overlay" class="modal-overlay">
  <div class="modal">
    <button class="modal-close" id="modal-close">&times;</button>
    <div id="modal-content"></div>
  </div>
</div>

<script>
  /* ============================================================
     URLs das 6 abas CSV (copiadas exatamente como voc√™ enviou)
     ============================================================ */
  const URL_REGRAS =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=994652615&single=true&output=csv";
  const URL_JORNADA =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=3760243&single=true&output=csv";
  const URL_PRESTACAO =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=997833295&single=true&output=csv";
  const URL_EXPERIENCE =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=0&single=true&output=csv";
  const URL_BNAV =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=569915638&single=true&output=csv";
  const URL_VENDAS =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=1865445107&single=true&output=csv";

  /* ============================================================
     Utilit√°rios
     ============================================================ */
  function normalize(str) {
    if (!str) return "";
    return str
      .toString()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .trim()
      .toLowerCase();
  }

  function parseNumberBR(v) {
    if (!v) return 0;
    v = v.toString().replace(/\s/g, "").replace(/\./g, "").replace(",", ".");
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }

  function parsePercent(v) {
    if (!v) return 0;
    v = v.toString().replace("%", "").trim();
    return parseNumberBR(v);
  }

  function parseCSV(text) {
    const lines = text.replace(/\r/g, "\n").split("\n").filter(l => l.trim() !== "");
    if (lines.length === 0) return [];
    const header = lines[0];
    const sep = (header.match(/;/g) || []).length > (header.match(/,/g) || []).length ? ";" : ",";
    const cols = header.split(sep).map(h => h.trim());
    const out = [];
    for (let i = 1; i < lines.length; i++) {
      const parts = lines[i].split(sep);
      const row = {};
      cols.forEach((c, idx) => (row[c] = (parts[idx] || "").trim()));
      out.push(row);
    }
    return out;
  }

  /* Helper para descobrir qual coluna usar pelo nome aproximado */
  function findKeyByPatterns(row, patterns) {
    const keys = Object.keys(row || {});
    for (const key of keys) {
      const nk = normalize(key);
      for (const p of patterns) {
        if (nk.includes(p)) return key;
      }
    }
    return null;
  }

  /* ============================================================
     Carregamento das 6 abas
     ============================================================ */
  async function loadAllCS() {
    const loading = document.getElementById("loading");
    try {
      loading.textContent = "Baixando dados‚Ä¶";

      const [REGRAS, JORNADA, PREST, EXP, BNAV, VEND] = await Promise.all([
        fetch(URL_REGRAS).then(r => r.text()),
        fetch(URL_JORNADA).then(r => r.text()),
        fetch(URL_PRESTACAO).then(r => r.text()),
        fetch(URL_EXPERIENCE).then(r => r.text()),
        fetch(URL_BNAV).then(r => r.text()),
        fetch(URL_VENDAS).then(r => r.text())
      ]);

      loading.textContent = "Convertendo CSV‚Ä¶";

      const regras = parseCSV(REGRAS);
      const jornada = parseCSV(JORNADA);
      const prest = parseCSV(PREST);
      const experience = parseCSV(EXP);
      const bnav = parseCSV(BNAV);
      const vendas = parseCSV(VEND);

      loading.textContent = "Normalizando e consolidando base‚Ä¶";
      const base = normalizeAll({ regras, jornada, prest, experience, bnav, vendas });

      loading.textContent = "Gerando gr√°ficos e tabelas‚Ä¶";
      renderAll(base);

      loading.classList.add("hidden");
    } catch (e) {
      console.error(e);
      loading.textContent = "Erro ao carregar dados. Verifique os links dos CSVs.";
    }
  }

  /* ============================================================
     Normaliza√ß√£o principal (regra, jornada, presta√ß√£o etc.)
     ============================================================ */
  function normalizeAll({ regras, jornada, prest, experience, bnav, vendas }) {
    /* Regras / planos */
    const regrasMap = {};
    const rSample = regras[0] || {};
    const rPlanoKey = findKeyByPatterns(rSample, ["plano"]);
    const rPrazoKey = findKeyByPatterns(rSample, ["prazo"]);
    const rValorKey = findKeyByPatterns(rSample, ["valor"]);

    regras.forEach(r => {
      const planoNome = r[rPlanoKey] || "";
      const planoNorm = normalize(planoNome);
      if (!planoNorm) return;
      regrasMap[planoNorm] = {
        planoOriginal: planoNome,
        prazo: rPrazoKey ? parseInt(r[rPrazoKey] || "0") || 0 : 0,
        valor: rValorKey ? parseNumberBR(r[rValorKey]) : 0,
        descricao: r["Descri√ß√£o"] || r["Descricao"] || ""
      };
    });

    /* Jornada */
    const jSample = jornada[0] || {};
    const jAlunoKey = findKeyByPatterns(jSample, ["aluno", "cliente", "nome"]);
    const jPlanoKey = findKeyByPatterns(jSample, ["plano"]);
    const jStatusKey = findKeyByPatterns(jSample, ["status do plano", "status"]);
    const jRiscoKey = findKeyByPatterns(jSample, ["risco"]);
    const jPrazoKey = findKeyByPatterns(jSample, ["prazo"]);
    const jAvancoKey = findKeyByPatterns(jSample, ["avanco", "avan√ßo"]);
    const jConclusaoKey = findKeyByPatterns(jSample, ["conclusao", "conclus√£o"]);
    const jDataIniKey = findKeyByPatterns(jSample, ["data inicio", "data de inicio", "in√≠cio"]);
    const jDataFimKey = findKeyByPatterns(jSample, ["data fim", "data final"]);

    const jornadaMap = {};
    jornada.forEach(j => {
      const nomeAluno = jAlunoKey ? j[jAlunoKey] : "";
      const nomeNorm = normalize(nomeAluno);
      if (!nomeNorm) return;

      const planoNome = jPlanoKey ? j[jPlanoKey] : "";
      const planoNorm = normalize(planoNome);

      const conclusaoStr = jConclusaoKey ? j[jConclusaoKey] : "";
      const avancoStr = jAvancoKey ? j[jAvancoKey] : "";

      const conclusao = conclusaoStr
        ? parsePercent(conclusaoStr)
        : parsePercent(avancoStr);

      jornadaMap[nomeNorm] = {
        aluno: nomeAluno || "",
        plano: planoNome || "",
        planoNorm,
        status: jStatusKey ? j[jStatusKey] || "" : "",
        risco: jRiscoKey ? j[jRiscoKey] || "" : "",
        prazo: jPrazoKey ? j[jPrazoKey] || "" : "",
        avanc: parsePercent(avancoStr),
        conclusao,
        dataInicio: jDataIniKey ? j[jDataIniKey] || "" : "",
        dataFim: jDataFimKey ? j[jDataFimKey] || "" : ""
      };
    });

    /* Presta√ß√£o de contas */
    const pSample = prest[0] || {};
    const pAlunoKey = findKeyByPatterns(pSample, ["aluno", "cliente", "nome"]);
    const pStatusKey = findKeyByPatterns(pSample, ["status"]);

    const prestMap = {};
    prest.forEach(p => {
      const nome = pAlunoKey ? p[pAlunoKey] : "";
      const nomeNorm = normalize(nome);
      if (!nomeNorm) return;
      const status = pStatusKey ? p[pStatusKey] || "" : "";
      const stNorm = normalize(status);
      prestMap[nomeNorm] = {
        status,
        atualizado:
          stNorm.includes("ok") ||
          stNorm.includes("em dia") ||
          stNorm.includes("enviado")
            ? 1
            : 0
      };
    });

    /* Experience */
    const eSample = experience[0] || {};
    const eAlunoKey = findKeyByPatterns(eSample, ["aluno", "cliente", "nome"]);
    const eMesKey = findKeyByPatterns(eSample, ["mes", "m√™s"]);
    const eEncontroKey = findKeyByPatterns(eSample, ["encontro"]);
    const ePresencaKey = findKeyByPatterns(eSample, ["presenca", "presen√ßa"]);

    const expMap = {};
    experience.forEach(e => {
      const nome = eAlunoKey ? e[eAlunoKey] : "";
      const nomeNorm = normalize(nome);
      if (!nomeNorm) return;

      if (!expMap[nomeNorm]) expMap[nomeNorm] = [];

      expMap[nomeNorm].push({
        mes: eMesKey ? e[eMesKey] || "" : "",
        encontro: eEncontroKey ? e[eEncontroKey] || "" : "",
        presenca:
          ePresencaKey &&
          normalize(e[ePresencaKey]).includes("sim")
            ? 1
            : 0
      });
    });

    /* Batalha Naval ‚Äì usando Oportunidade total por aluno */
    const bSample = bnav[0] || {};
    const bAlunoKey = findKeyByPatterns(bSample, ["aluno", "cliente", "nome"]);
    const bPotKey = findKeyByPatterns(bSample, ["oportunidade total por aluno", "oportunidade total", "potencial", "upsell"]);
    const bStatusKey = findKeyByPatterns(bSample, ["status"]);

    const bnMap = {};
    bnav.forEach(b => {
      const nome = bAlunoKey ? b[bAlunoKey] : "";
      const nomeNorm = normalize(nome);
      if (!nomeNorm) return;

      const potencial = bPotKey ? parseNumberBR(b[bPotKey]) : 0;

      bnMap[nomeNorm] = {
        potencial,
        status: bStatusKey ? b[bStatusKey] || "" : "",
        observacao: b["Observa√ß√£o"] || b["Observacao"] || ""
      };
    });

    /* Vendas / Renova√ß√µes */
    const vSample = vendas[0] || {};
    const vAlunoKey = findKeyByPatterns(vSample, ["aluno", "cliente", "nome"]);
    const vDataKey = findKeyByPatterns(vSample, ["data"]);
    const vProdutoKey = findKeyByPatterns(vSample, ["produto", "plano", "descricao"]);
    const vValorKey = findKeyByPatterns(vSample, ["valor"]);

    const vendMap = {};
    vendas.forEach(v => {
      const nome = vAlunoKey ? v[vAlunoKey] : "";
      const nomeNorm = normalize(nome);
      if (!nomeNorm) return;

      vendMap[nomeNorm] = {
        ultimaCompra: vDataKey ? v[vDataKey] || "" : "",
        produto: vProdutoKey ? v[vProdutoKey] || "" : "",
        valor: vValorKey ? parseNumberBR(v[vValorKey]) : 0
      };
    });

    /* Base final (pivot principal = Jornada) */
    const alunos = Object.keys(jornadaMap);
    const baseFinal = alunos.map(n => {
      const j = jornadaMap[n];
      const p = prestMap[n] || {};
      const ex = expMap[n] || [];
      const bn = bnMap[n] || {};
      const vd = vendMap[n] || {};
      const rg = regrasMap[j.planoNorm] || {};

      return {
        nomeOriginal: j.aluno,
        nomeNorm: n,

        plano: j.plano,
        status: j.status,
        risco: j.risco,
        prazo: j.prazo,
        avanc: j.avanc,
        conclusao: j.conclusao,
        dataInicio: j.dataInicio,
        dataFim: j.dataFim,

        prazoRegra: rg.prazo || 0,
        valorRegra: rg.valor || 0,

        prestStatus: p.status || "",
        prestAtualizado: p.atualizado || 0,

        experience: ex,

        potencial: bn.potencial || 0,
        bnStatus: bn.status || "",
        observacaoBN: bn.observacao || "",

        ultimaCompra: vd.ultimaCompra || "",
        produto: vd.produto || "",
        valorCompra: vd.valor || 0
      };
    });

    return baseFinal;
  }

  /* ============================================================
     Render ‚Äì KPIs, gr√°ficos, tabelas, modal
     ============================================================ */
  function renderAll(base) {
    window.CS_BASE = base;

    buildKPIs(base);
    buildFilters(base);
    buildChartAvanco(base);
    buildChartChurn(base);
    buildChartPrestacao(base);
    buildChartUpsell(base);
    buildExperienceSummary(base);
    buildTables(base);
    setupModal();
  }

  /* KPIs */
  function buildKPIs(base) {
    const ativos = base.filter(a => !normalize(a.status).includes("encerr")).length;
    const encerrados = base.length - ativos;

    document.getElementById("kpi-alunos-ativos").textContent = ativos;
    document.getElementById("kpi-alunos-ativos-extra").textContent =
      encerrados + " encerrados";

    const mediaConclusao =
      base.reduce((sum, a) => sum + (a.conclusao || 0), 0) /
      (base.length || 1);

    document.getElementById("kpi-taxasucesso").textContent =
      mediaConclusao.toFixed(1) + "%";
    document.getElementById("kpi-taxasucesso-extra").textContent =
      "M√©dia geral da trilha";

    const prestOK = base.filter(a => a.prestAtualizado === 1).length;
    const prestPerc = (prestOK / (base.length || 1)) * 100;

    document.getElementById("kpi-prestacao").textContent =
      prestPerc.toFixed(1) + "%";
    document.getElementById("kpi-prestacao-extra").textContent =
      prestOK + " de " + base.length + " atualizaram";

    const totalUpsell = base.reduce((sum, a) => sum + (a.potencial || 0), 0);
    document.getElementById("kpi-upsell").textContent =
      "R$ " + totalUpsell.toLocaleString("pt-BR");
    document.getElementById("kpi-upsell-extra").textContent =
      "Potencial total da base (Batalha Naval)";
  }

  /* Preenche combobox de filtros (sem mexer nos gr√°ficos ainda) */
  function buildFilters(base) {
    const planoSel = document.getElementById("filtro-plano");
    const mesSel = document.getElementById("filtro-mes");
    const encSel = document.getElementById("filtro-encontro");

    if (planoSel) {
      const planos = Array.from(
        new Set(base.map(a => a.plano).filter(Boolean))
      ).sort();
      planos.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        planoSel.appendChild(opt);
      });
    }

    const mesesSet = new Set();
    const encontrosSet = new Set();
    base.forEach(a => {
      (a.experience || []).forEach(e => {
        if (e.mes) mesesSet.add(e.mes);
        if (e.encontro) encontrosSet.add(e.encontro);
      });
    });

    if (mesSel) {
      Array.from(mesesSet)
        .sort()
        .forEach(m => {
          const opt = document.createElement("option");
          opt.value = m;
          opt.textContent = m;
          mesSel.appendChild(opt);
        });
    }

    if (encSel) {
      Array.from(encontrosSet)
        .sort()
        .forEach(e => {
          const opt = document.createElement("option");
          opt.value = e;
          opt.textContent = e;
          encSel.appendChild(opt);
        });
    }
  }

  /* Gr√°fico ‚Äì Avan√ßo da Jornada (foco em ativos) */
  function buildChartAvanco(base) {
    const canvas = document.getElementById("chart-avanco");
    if (!canvas) return;

    const ativos = base.filter(
      a => !normalize(a.status).includes("encerr") &&
           !normalize(a.status).includes("finaliz") &&
           !normalize(a.status).includes("conclu")
    );

    // Ordena do menor para o maior (mostrar quem est√° atrasado primeiro)
    ativos.sort((a, b) => (a.conclusao || 0) - (b.conclusao || 0));

    const labels = ativos.map(a => a.nomeOriginal);
    const data = ativos.map(a => a.conclusao || 0);

    new Chart(canvas, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "Conclus√£o (%)",
            data,
            backgroundColor: "#1F73B7",
            borderWidth: 0
          }
        ]
      },
      options: {
        indexAxis: "y",
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: {
            max: 100,
            ticks: { callback: v => v + "%" }
          }
        }
      }
    });
  }

  /* Gr√°fico ‚Äì Risco de Churn */
  function buildChartChurn(base) {
    const canvas = document.getElementById("chart-churn");
    if (!canvas) return;

    const counts = {
      saudavel: 0,
      atencao: 0,
      alto: 0,
      encerrado: 0,
      outros: 0
    };

    base.forEach(a => {
      const r = normalize(a.risco);
      if (!r) {
        counts.outros++;
      } else if (r.includes("saud")) {
        counts.saudavel++;
      } else if (r.includes("aten") || r.includes("moder")) {
        counts.atencao++;
      } else if (r.includes("alto") || r.includes("critico") || r.includes("cr√≠tico") || r.includes("üö®")) {
        counts.alto++;
      } else if (r.includes("encerr") || r.includes("cancel")) {
        counts.encerrado++;
      } else {
        counts.outros++;
      }
    });

    new Chart(canvas, {
      type: "doughnut",
      data: {
        labels: ["Saud√°vel", "Aten√ß√£o", "Alto risco", "Encerrado", "Outros"],
        datasets: [
          {
            data: [
              counts.saudavel,
              counts.atencao,
              counts.alto,
              counts.encerrado,
              counts.outros
            ],
            backgroundColor: [
              "#2ECC71",
              "#C8A300",
              "#CC3333",
              "#1F73B7",
              "#FF7F0E"
            ]
          }
        ]
      },
      options: {
        responsive: true,
        cutout: "55%",
        plugins: {
          legend: { position: "bottom" }
        }
      }
    });
  }

  /* Gr√°fico ‚Äì Presta√ß√£o de Contas */
  function buildChartPrestacao(base) {
    const canvas = document.getElementById("chart-prestacao");
    if (!canvas) return;

    let ok = 0,
      pend = 0;

    base.forEach(a => {
      if (a.prestAtualizado === 1) ok++;
      else pend++;
    });

    new Chart(canvas, {
      type: "pie",
      data: {
        labels: ["Atualizado", "Pendente"],
        datasets: [
          {
            data: [ok, pend],
            backgroundColor: ["#2ECC71", "#CC3333"]
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" }
        }
      }
    });
  }

  /* Gr√°fico ‚Äì Upsell / Batalha Naval */
  function buildChartUpsell(base) {
    const canvas = document.getElementById("chart-upsell");
    if (!canvas) return;

    // mostra apenas quem tem potencial > 0
    const comPotencial = base.filter(a => (a.potencial || 0) > 0);
    comPotencial.sort((a, b) => (b.potencial || 0) - (a.potencial || 0));

    const labels = comPotencial.map(a => a.nomeOriginal);
    const data = comPotencial.map(a => a.potencial || 0);

    new Chart(canvas, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "Oportunidade total por aluno (R$)",
            data,
            backgroundColor: "#C8A300"
          }
        ]
      },
      options: {
        indexAxis: "y",
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: {
            ticks: {
              callback: v =>
                "R$ " + Number(v).toLocaleString("pt-BR", { maximumFractionDigits: 0 })
            }
          }
        }
      }
    });
  }

  /* Experience ‚Äì resumo simples */
  function buildExperienceSummary(base) {
    const div = document.getElementById("experience-summary");
    if (!div) return;

    let totalRegistros = 0;
    let totalPresencas = 0;
    const meses = new Set();
    const encontros = new Set();

    base.forEach(a => {
      (a.experience || []).forEach(e => {
        totalRegistros++;
        if (e.presenca) totalPresencas++;
        if (e.mes) meses.add(e.mes);
        if (e.encontro) encontros.add(e.encontro);
      });
    });

    if (totalRegistros === 0) {
      div.textContent = "Nenhum dado de presen√ßa registrado ainda.";
      return;
    }

    const taxa = (totalPresencas / totalRegistros) * 100;

    div.innerHTML = `
      <div class="exp-line"><strong>Taxa geral de presen√ßa:</strong> ${taxa.toFixed(1)}%</div>
      <div class="exp-line"><strong>Registros de presen√ßa:</strong> ${totalPresencas} de ${totalRegistros}</div>
      <div class="exp-line"><strong>Meses com encontros:</strong> ${meses.size}</div>
      <div class="exp-line"><strong>Tipos de encontros:</strong> ${encontros.size}</div>
    `;
  }

  /* Tabelas ‚Äì Aten√ß√£o e Encerrados */
  function buildTables(base) {
    const tbodyA = document.getElementById("table-atencao");
    const tbodyE = document.getElementById("table-encerrados");
    tbodyA.innerHTML = "";
    tbodyE.innerHTML = "";

    base.forEach(a => {
      const linha = `
        <tr>
          <td><span class="link-aluno" onclick="openModal('${a.nomeNorm}')">${a.nomeOriginal}</span></td>
          <td>${a.plano || "-"}</td>
          <td>${(a.conclusao || 0).toFixed(1)}%</td>
          <td>${a.prazo || "-"}</td>
          <td>${a.risco || "-"}</td>
          <td>${a.prestStatus || "-"}</td>
          <td>R$ ${(a.potencial || 0).toLocaleString("pt-BR")}</td>
        </tr>
      `;

      if (normalize(a.status).includes("encerr") ||
          normalize(a.status).includes("finaliz") ||
          normalize(a.status).includes("conclu")) {
        tbodyE.insertAdjacentHTML("beforeend", linha);
      } else {
        tbodyA.insertAdjacentHTML("beforeend", linha);
      }
    });
  }

  /* Modal */
  function setupModal() {
    const overlay = document.getElementById("modal-overlay");
    const closeBtn = document.getElementById("modal-close");

    closeBtn.addEventListener("click", () => {
      overlay.classList.remove("show");
    });

    overlay.addEventListener("click", e => {
      if (e.target === overlay) {
        overlay.classList.remove("show");
      }
    });
  }

  function openModal(nomeNorm) {
    const a = (window.CS_BASE || []).find(x => x.nomeNorm === nomeNorm);
    if (!a) return;

    const html = `
      <div class="modal-header">
        <h2>${a.nomeOriginal}</h2>
        <span>${a.plano || ""}</span>
      </div>
      <div class="modal-grid">
        <div class="modal-block">
          <h3>Jornada</h3>
          <p><strong>Status do plano:</strong> ${a.status || "-"}</p>
          <p><strong>Conclus√£o:</strong> ${(a.conclusao || 0).toFixed(1)}%</p>
          <p><strong>Risco de churn:</strong> ${a.risco || "-"}</p>
          <p><strong>Prazo:</strong> ${a.prazo || "-"}</p>
          <p><strong>In√≠cio:</strong> ${a.dataInicio || "-"}</p>
          <p><strong>Fim previsto/real:</strong> ${a.dataFim || "-"}</p>
        </div>
        <div class="modal-block">
          <h3>Financeiro & Upsell</h3>
          <p><strong>Presta√ß√£o de contas:</strong> ${a.prestStatus || "-"}</p>
          <p><strong>Oportunidade total por aluno:</strong> R$ ${(a.potencial || 0).toLocaleString("pt-BR")}</p>
          <p><strong>√öltima compra:</strong> ${a.ultimaCompra || "-"}</p>
          <p><strong>Produto:</strong> ${a.produto || "-"}</p>
        </div>
      </div>
    `;

    document.getElementById("modal-content").innerHTML = html;
    document.getElementById("modal-overlay").classList.add("show");
  }

  /* Start */
  loadAllCS();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
>
<head>
<meta charset="UTF-8" />
<title>CS – Jornada do Aluno</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: system-ui;
  margin: 0; padding: 0;
  background: #F5F6FA;
}

.topbar {
  background: #0A1A2F;
  color: white;
  padding: 12px 24px;
  font-size: 18px;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(0,0,0,.25);
}

.container {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 16px;
  padding: 16px;
}

.card {
  background: white;
  border-radius: 10px;
  padding: 12px 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,.08);
}

h2 { margin: 0 0 8px; }

.scroll {
  max-height: 360px;
  overflow: auto;
  border: 1px solid #DDD;
  border-radius: 10px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

thead {
  background: #E3E6ED;
  font-weight: 600;
  position: sticky;
  top: 0;
}

th, td {
  padding: 6px 8px;
  border-bottom: 1px solid #EEE;
}
.status-pill {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 999px;
}
.pill-ativo { background: rgba(46,204,113,.15); color: #2ECC71 }
.pill-churn { background: rgba(204,51,51,.15); color: #CC3333 }

</style>
</head>

<body>

<div class="topbar">Dashboard CS – Jornada do Aluno</div>

<div class="container">

<!------------------------- FILTROS ------------------------------>
<div class="card">
  <h3>Filtros</h3>

  <label>Status</label>
  <select id="fltStatus">
    <option value="">Todos</option>
  </select>

  <label>Risco churn</label>
  <select id="fltRisco">
    <option value="">Todos</option>
  </select>

  <button id="btnReset" style="margin-top:8px;">Limpar filtros</button>

  <div id="loading" style="font-size:12px;color:#999;margin-top:6px">
    Carregando CSV...
  </div>
</div>

<!------------------------- CONTEÚDO ------------------------------>
<div style="display:flex;flex-direction:column;gap:16px;">

<!---- CARDS ---->
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
  <div class="card">
    <div>Total alunos</div>
    <h2 id="cardTotal">–</h2>
  </div>

  <div class="card">
    <div>Ativos</div>
    <h2 id="cardAtivos">–</h2>
  </div>

  <div class="card">
    <div>Churn</div>
    <h2 id="cardChurn">–</h2>
  </div>

  <div class="card">
    <div>Risco (Médio + Alto)</div>
    <h2 id="cardRisco">–</h2>
  </div>
</div>

<!---- GRÁFICOS ---->
<div class="card">
  <h2>Status</h2>
  <canvas id="chart-status" height="200"></canvas>
</div>

<div class="card">
  <h2>Churn (cores confirmadas)</h2>
  <canvas id="chart-churn" height="200"></canvas>
</div>

<!---- TABELA ---->
<div class="card">
  <h2>Detalhamento por aluno</h2>

  <div class="scroll">
    <table>
      <thead>
        <tr>
          <th>Aluno</th>
          <th>Status</th>
          <th>Risco churn</th>
          <th>Oportunidade</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

</div>
</div>

<!--------------------- SCRIPT --------------------->
<script>
const CSV_URL =
  "COLE_AQUI_O_LINK_DO_CSV_PUBLICADO";

let raw = [];
let filtered = [];

let chartStatus = null;
let chartChurn  = null;

async function loadCSV() {
  const res = await fetch(CSV_URL);
  const txt = await res.text();

  const lines = txt.trim().split(/\r?\n/);
  const header = lines[0].split(",");

  raw = lines.slice(1).map(line => {
    const c = line.split(",");
    return {
      aluno: c[0],
      status: c[1],
      riscoChurn: c[2],
      oportunidade: parseFloat(c[3].replace("R$","").replace(".","").replace(",",".")) || 0
    }
  });

  filtered = raw.slice();
  buildFilters();
  updateAll();
  document.getElementById("loading").textContent = "";
}

function buildFilters() {
  const st = [...new Set(raw.map(r=>r.status))].sort();
  const rs = [...new Set(raw.map(r=>r.riscoChurn))].sort();

  const fltStatus = document.getElementById("fltStatus");
  st.forEach(s=>{
    const o=document.createElement("option");
    o.value=s;
    o.textContent=s;
    fltStatus.appendChild(o);
  });

  const fltRisco = document.getElementById("fltRisco");
  rs.forEach(s=>{
    const o=document.createElement("option");
    o.value=s;
    o.textContent=s;
    fltRisco.appendChild(o);
  });

  fltStatus.onchange = applyFilters;
  fltRisco.onchange  = applyFilters;
  document.getElementById("btnReset").onclick = ()=>{
    fltStatus.value="";
    fltRisco.value="";
    applyFilters();
  }
}

function applyFilters() {
  const fs = document.getElementById("fltStatus").value;
  const fr = document.getElementById("fltRisco").value;

  filtered = raw.filter(r=>{
    if (fs && r.status!==fs) return false;
    if (fr && r.riscoChurn!==fr) return false;
    return true;
  });

  updateAll();
}

function updateAll() {
  updateCards();
  buildStatusChart();
  buildChurnChart();
  buildTable();
}

/************* DASH PARTS ****************/

function updateCards() {
  const total = filtered.length;
  const ativos = filtered.filter(r=> !isChurn(r)).length;
  const churn = filtered.filter(r=> isChurn(r)).length;
  const risco = filtered.filter(r=> isRisco(r)).length;

  cardTotal.textContent = total;
  cardAtivos.textContent = ativos;
  cardChurn.textContent = churn;
  cardRisco.textContent = risco;
}

function isChurn(r) {
  const t = r.status.toLowerCase();
  return t.includes("churn") || t.includes("encerr");
}

function isRisco(r) {
  const t = r.riscoChurn.toLowerCase();
  return t.includes("alto") || t.includes("moderado");
}

function buildStatusChart() {
  const ctx = document.getElementById("chart-status").getContext("2d");
  if (chartStatus) chartStatus.destroy();

  const counts = {};
  filtered.forEach(r=>{
    counts[r.status] = (counts[r.status]||0)+1;
  });

  chartStatus = new Chart(ctx,{
    type:"bar",
    data:{
      labels:Object.keys(counts),
      datasets:[{data:Object.values(counts)}]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}}
    }
  });
}

/************* ESTA É A PARTE QUE VOCÊ PEDIU *************/
function buildChurnChart() {
  const ctx = document.getElementById("chart-churn").getContext("2d");
  if (chartChurn) chartChurn.destroy();

  const riskCounts = {};
  filtered.forEach(j => {
    const label = (j.riscoChurn || "Não informado").trim();
    riskCounts[label] = (riskCounts[label] || 0) + 1;
  });

  const labels = Object.keys(riskCounts);
  const data   = Object.values(riskCounts);

  // Mapeamento de cores
  const colors = labels.map(label => {
    const l = label.toLowerCase();

    if (l.includes("alto"))     return "#CC3333";  // vermelho
    if (l.includes("moderado")) return "#C8A300";  // amarelo
    if (l.includes("saud"))     return "#2ECC71";  // verde
    if (l.includes("encerr"))   return "#1F73B7";  // azul
    if (l.includes("alert"))    return "#FF7F0E";  // laranja

    return "#666666"; // fallback
  });

  chartChurn = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: colors
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" }
      },
      cutout: "55%"
    }
  });
}
/*******************************************************/

function buildTable() {
  const tb = document.getElementById("tbody");
  tb.innerHTML = "";

  filtered.forEach(r=>{
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${r.aluno}</td>
      <td><span class="status-pill ${isChurn(r) ? "pill-churn":"pill-ativo"}">
        ${r.status}
      </span></td>
      <td>${r.riscoChurn}</td>
      <td>R$ ${r.oportunidade.toFixed(2)}</td>
    `;

    tb.appendChild(tr);
  });
}

loadCSV();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard ‚Äì CS, Upsell & Renova√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg-page: #f3f4fb;
      --bg-card: #ffffff;
      --border: #e5e7eb;
      --primary: #101827;
      --muted: #6b7280;
      --accent: #6366f1;
      --accent-soft: #eef2ff;
      --radius-lg: 16px;
      --radius-md: 12px;
      --shadow-soft: 0 14px 28px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top left, #e5e7ff 0, #f1f5f9 40%, #f9fafb 75%);
      color: var(--primary);
      padding: 24px;
    }

    .page {
      max-width: 1280px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
      align-items: flex-end;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(99, 102, 241, 0.06);
      border: 1px solid rgba(99, 102, 241, 0.3);
      font-size: 0.75rem;
      color: var(--accent);
      font-weight: 500;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.22);
    }

    header h1 {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    header p {
      font-size: 0.9rem;
      color: var(--muted);
      max-width: 640px;
    }

    .layout {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap: 18px;
      align-items: flex-start;
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    /* Filtros */
    .filters-card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(12px);
      border-radius: var(--radius-lg);
      padding: 16px 14px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .filters-header h2 {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .filters-header span {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
    }

    .filter-label {
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--muted);
    }

    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 9px;
      border: 1px solid var(--border);
      background-color: #fff;
      font-size: 0.8rem;
      color: var(--primary);
      outline: none;
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 14px) calc(50% - 3px), calc(100% - 9px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
    }

    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.35);
      transform: translateY(-1px);
    }

    .filters-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
    }

    .btn-reset {
      border: none;
      background: transparent;
      font-size: 0.75rem;
      color: var(--accent);
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s ease, transform 0.05s ease;
    }

    .btn-reset:hover {
      background: rgba(99, 102, 241, 0.08);
      transform: translateY(-1px);
    }

    /* Conte√∫do principal */
    .main {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(12px);
      border-radius: var(--radius-lg);
      padding: 14px 16px 16px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .card-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
    }

    .card-subtitle {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .chip {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.72rem;
      color: var(--muted);
    }

    /* Card Potencial */
    .potencial-body {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .potencial-value {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .potencial-meta {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .btn-mapa-oportunidades {
      margin-top: 4px;
      display: inline-flex;
      align-items: center;
      padding: 5px 10px;
      font-size: 0.75rem;
      border-radius: 999px;
      border: none;
      background: #fee2e2;
      color: #b91c1c;
      cursor: default;
    }

    /* Grid alto n√≠vel */
    .grid-top {
      display: grid;
      grid-template-columns: minmax(0, 0.75fr) minmax(0, 1.25fr);
      gap: 12px;
    }

    @media (max-width: 980px) {
      .grid-top {
        grid-template-columns: 1fr;
      }
    }

    /* Batalha Naval */
    .chart-wrapper {
      position: relative;
      height: 260px;
    }

    /* Resultados Upsell / Renova√ß√£o */
    .chart-large-wrapper {
      position: relative;
      height: 260px;
    }

    .card-footer {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .card-footer strong {
      font-weight: 600;
      color: var(--primary);
    }

    /* Tabela CS */
    .cs-table-wrapper {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      overflow: hidden;
      margin-top: 8px;
      background: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      min-width: 640px;
    }

    thead {
      background: #f3f4f6;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      font-size: 0.74rem;
      color: #4b5563;
    }

    tbody tr:nth-child(even) td {
      background: #fafafa;
    }

    tbody tr:hover td {
      background: #eef2ff;
    }

    .cs-table-scroll {
      max-height: 280px;
      overflow: auto;
    }

    .pill-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
    }

    .pill-status.alto-risco {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .pill-status.saudavel {
      background: #ecfdf3;
      color: #15803d;
      border: 1px solid #bbf7d0;
    }

    .pill-status.outro {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: currentColor;
    }

    .loading,
    .error-msg {
      font-size: 0.8rem;
      color: var(--muted);
      padding: 10px 0;
    }

    .error-msg {
      color: #b91c1c;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title-block">
        <div class="badge">
          <span class="badge-dot"></span>
          <span>Dash CS & Upsell ‚Äì Vendas/Renova√ß√£o (CSV √önico)</span>
        </div>
        <h1>Mapa de risco, oportunidades e resultados comerciais</h1>
        <p>
          Visualiza√ß√£o unificada da jornada dos alunos, potencial de upsell/renova√ß√£o e resultados reais de vendas,
          alimentada pela aba <strong>Vendas/Renova√ß√µes</strong> da planilha.
        </p>
      </div>
    </header>

    <div class="layout">
      <!-- FILTROS -->
      <aside class="filters-card">
        <div class="filters-header">
          <div>
            <h2>Filtros</h2>
            <span>Refine a vis√£o da base</span>
          </div>
        </div>

        <div class="filter-group">
          <label for="filter-mes-churn" class="filter-label">M√™s do churn</label>
          <select id="filter-mes-churn">
            <option value="">Todos os meses</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="filter-risco" class="filter-label">Risco</label>
          <select id="filter-risco">
            <option value="">Todos</option>
          </select>
        </div>

        <div class="filters-actions">
          <button type="button" class="btn-reset" id="btn-reset">
            <span>‚Ü∫</span>
            <span>Limpar filtros</span>
          </button>
        </div>
      </aside>

      <!-- CONTE√öDO PRINCIPAL -->
      <div class="main">
        <!-- GRID TOPO: Potencial + Batalha Naval -->
        <section class="grid-top">
          <!-- Potencial Upsell/Renova√ß√£o -->
          <div class="card">
            <div class="card-header">
              <div class="card-title-block">
                <span class="card-title">Potencial de Upsell / Renova√ß√£o</span>
                <span class="card-subtitle">
                  Soma das oportunidades comerciais mapeadas na aba Vendas/Renova√ß√µes (coluna
                  "Oportunidade total por aluno").
                </span>
              </div>
            </div>
            <div class="potencial-body">
              <div class="potencial-value" id="kpi-potencial">R$ 0,00</div>
              <div class="potencial-meta" id="kpi-potencial-meta">
                0 aluno(s) com potencial comercial mapeado.
              </div>
              <button class="btn-mapa-oportunidades" type="button">
                Mapa de oportunidades comerciais
              </button>
            </div>
          </div>

          <!-- Oportunidades ‚Äì Batalha Naval -->
          <div class="card">
            <div class="card-header">
              <div class="card-title-block">
                <span class="card-title">Oportunidades ‚Äì Batalha Naval</span>
                <span class="card-subtitle">
                  Valor potencial de novos produtos / renova√ß√µes por aluno (coluna "Oportunidade total por aluno").
                </span>
              </div>
              <div class="chip">Upsell & Renova√ß√£o</div>
            </div>
            <div class="chart-wrapper">
              <canvas id="chart-batalha"></canvas>
            </div>
          </div>
        </section>

        <!-- Resultados Upsell & Renova√ß√£o -->
        <section class="card">
          <div class="card-header">
            <div class="card-title-block">
              <span class="card-title">Resultados ‚Äì Upsell & Renova√ß√£o</span>
              <span class="card-subtitle">
                Vendas efetivadas por m√™s (aba Vendas/Renova√ß√µes), separadas por tipo.
              </span>
            </div>
            <div class="chip">Resultados reais</div>
          </div>
          <div class="chart-large-wrapper">
            <canvas id="chart-resultados"></canvas>
          </div>
          <div class="card-footer" id="resumo-resultados"></div>
        </section>

        <!-- Mapa de risco e oportunidade (tabela CS) -->
        <section class="card">
          <div class="card-header">
            <div class="card-title-block">
              <span class="card-title">Alunos que precisam de aten√ß√£o do CS</span>
              <span class="card-subtitle">
                Mapa de risco e oportunidade ‚Äì clique no nome do cliente (se quiser adaptar para link/modal).
              </span>
            </div>
            <div class="chip">Prioridade de a√ß√£o</div>
          </div>

          <div class="cs-table-wrapper">
            <div class="cs-table-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Cliente</th>
                    <th>Plano</th>
                    <th>Avan√ßo</th>
                    <th>Prazo</th>
                    <th>Risco</th>
                    <th>Presta√ß√£o</th>
                    <th>Oportunidade</th>
                  </tr>
                </thead>
                <tbody id="cs-table-body">
                  <tr>
                    <td colspan="7" class="loading">
                      Carregando dados‚Ä¶
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <div id="error-container" class="error-msg"></div>
      </div>
    </div>
  </div>

  <script>
    // ================== CONFIGURA√á√ÉO B√ÅSICA ==================
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=1865445107&single=true&output=csv";

    let originalData = [];
    let filteredData = [];
    let headerFields = [];

    // Mapeamento de campos (ser√° detectado por nome)
    const FIELDS = {
      mesChurn: null,
      risco: null,
      oportunidade: null,
      tipoVenda: null,
      valorVenda: null,
      cliente: null,
      plano: null,
      avanco: null,
      prazo: null,
      prestacao: null,
    };

    // Refer√™ncias DOM
    const mesChurnSelect = document.getElementById("filter-mes-churn");
    const riscoSelect = document.getElementById("filter-risco");
    const resetButton = document.getElementById("btn-reset");

    const kpiPotencial = document.getElementById("kpi-potencial");
    const kpiPotencialMeta = document.getElementById("kpi-potencial-meta");
    const csTableBody = document.getElementById("cs-table-body");
    const errorContainer = document.getElementById("error-container");
    const resumoResultados = document.getElementById("resumo-resultados");

    let chartBatalha = null;
    let chartResultados = null;

    // ================== FUN√á√ïES UTIL ==================
    function normalizeFieldName(name) {
      return name
        .toString()
        .trim()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }

    function toNumber(value) {
      if (value === null || value === undefined) return 0;
      let v = String(value).trim();
      if (!v) return 0;
      v = v.replace(/\s/g, "").replace(/R\$/gi, "");
      // remove pontos de milhar e troca v√≠rgula por ponto
      v = v.replace(/\./g, "").replace(",", ".");
      const num = parseFloat(v);
      return isNaN(num) ? 0 : num;
    }

    function formatCurrencyBR(value) {
      return value.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL",
        maximumFractionDigits: 2,
      });
    }

    // ================== CARREGAMENTO CSV ==================
    function loadCSV() {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          try {
            headerFields = results.meta.fields || [];
            originalData = (results.data || []).filter((row) =>
              Object.values(row).some((v) => String(v || "").trim() !== "")
            );

            if (!headerFields.length || !originalData.length) {
              throw new Error("N√£o foi poss√≠vel carregar dados v√°lidos do CSV.");
            }

            detectFields();
            buildFilters();
            applyFilters();
          } catch (err) {
            showError(err.message || "Erro ao processar o CSV.");
          }
        },
        error: function (err) {
          showError("Erro ao carregar o CSV: " + (err?.message || "desconhecido"));
        },
      });
    }

    // ================== DETEC√á√ÉO DE COLUNAS ==================
    function detectFields() {
      headerFields.forEach((name) => {
        const n = normalizeFieldName(name);

        if (!FIELDS.mesChurn && n.includes("mes") && n.includes("churn")) {
          FIELDS.mesChurn = name;
        }
        if (!FIELDS.risco && n.includes("risco")) {
          FIELDS.risco = name;
        }
        if (!FIELDS.tipoVenda && (n.includes("tipo") || n.includes("upsell") || n.includes("renovacao"))) {
          FIELDS.tipoVenda = name;
        }
        if (!FIELDS.valorVenda && (n.includes("valor") || n.includes("fatur") || n.includes("receita"))) {
          FIELDS.valorVenda = name;
        }
        if (!FIELDS.cliente && n.includes("cliente")) {
          FIELDS.cliente = name;
        }
        if (!FIELDS.plano && n.includes("plano")) {
          FIELDS.plano = name;
        }
        if (!FIELDS.avanco && (n.includes("avanco") || n.includes("progresso"))) {
          FIELDS.avanco = name;
        }
        if (!FIELDS.prazo && n.includes("prazo")) {
          FIELDS.prazo = name;
        }
        if (!FIELDS.prestacao && (n.includes("prestacao") || n.includes("preenchido"))) {
          FIELDS.prestacao = name;
        }
      });

      // MARCA explicitamente a coluna de oportunidade que voc√™ usou
      const nomeExatoOportunidade = "Oportunidade total por aluno";
      if (headerFields.includes(nomeExatoOportunidade)) {
        FIELDS.oportunidade = nomeExatoOportunidade;
      } else {
        // fallback: procura qualquer coluna com "oportunidade" no nome
        const found = headerFields.find((name) =>
          normalizeFieldName(name).includes("oportunidade")
        );
        if (found) FIELDS.oportunidade = found;
      }
    }

    // ================== FILTROS ==================
    function buildFilters() {
      // M√™s do churn
      if (FIELDS.mesChurn) {
        const setMes = new Set();
        originalData.forEach((row) => {
          const v = (row[FIELDS.mesChurn] || "").toString().trim();
          if (v) setMes.add(v);
        });
        Array.from(setMes)
          .sort()
          .forEach((v) => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            mesChurnSelect.appendChild(opt);
          });
      } else {
        mesChurnSelect.innerHTML = '<option value="">(Coluna "M√™s do churn" n√£o encontrada)</option>';
        mesChurnSelect.disabled = true;
      }

      // Risco
      if (FIELDS.risco) {
        const setRisco = new Set();
        originalData.forEach((row) => {
          const v = (row[FIELDS.risco] || "").toString().trim();
          if (v) setRisco.add(v);
        });
        Array.from(setRisco)
          .sort((a, b) => a.localeCompare(b, "pt-BR", { sensitivity: "base" }))
          .forEach((v) => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            riscoSelect.appendChild(opt);
          });
      } else {
        riscoSelect.innerHTML = '<option value="">(Coluna "Risco" n√£o encontrada)</option>';
        riscoSelect.disabled = true;
      }
    }

    function applyFilters() {
      const selectedMes = mesChurnSelect.disabled ? "" : mesChurnSelect.value;
      const selectedRisco = riscoSelect.disabled ? "" : riscoSelect.value;

      filteredData = originalData.filter((row) => {
        let ok = true;

        if (selectedMes && FIELDS.mesChurn) {
          const v = (row[FIELDS.mesChurn] || "").toString().trim();
          if (v !== selectedMes) ok = false;
        }

        if (selectedRisco && FIELDS.risco) {
          const v = (row[FIELDS.risco] || "").toString().trim();
          if (v !== selectedRisco) ok = false;
        }

        return ok;
      });

      updatePotencial();
      updateBatalhaNaval();
      updateResultados();
      updateCsTable();
    }

    // ================== POTENCIAL UPS/RENOV ==================
    function updatePotencial() {
      if (!FIELDS.oportunidade) {
        kpiPotencial.textContent = "R$ 0,00";
        kpiPotencialMeta.textContent = "Coluna 'Oportunidade total por aluno' n√£o localizada.";
        return;
      }

      let total = 0;
      let alunosComOportunidade = 0;
      const alunosSet = new Set();

      filteredData.forEach((row) => {
        const valor = toNumber(row[FIELDS.oportunidade]);
        if (valor > 0) {
          total += valor;
          const cliente =
            (FIELDS.cliente && row[FIELDS.cliente]) || "(sem nome)";
          alunosSet.add(cliente);
        }
      });

      alunosComOportunidade = alunosSet.size;
      kpiPotencial.textContent = formatCurrencyBR(total);
      kpiPotencialMeta.textContent = `${alunosComOportunidade} aluno(s) com potencial comercial mapeado.`;
    }

    // ================== BATALHA NAVAL ==================
    function updateBatalhaNaval() {
      if (!FIELDS.oportunidade) {
        if (chartBatalha) chartBatalha.destroy();
        const ctx = document.getElementById("chart-batalha").getContext("2d");
        chartBatalha = new Chart(ctx, {
          type: "bar",
          data: { labels: [], datasets: [] },
        });
        return;
      }

      // Agrupa por cliente
      const mapa = new Map(); // cliente -> soma oportunidade
      filteredData.forEach((row) => {
        const valor = toNumber(row[FIELDS.oportunidade]);
        if (valor <= 0) return;
        const cliente =
          (FIELDS.cliente && row[FIELDS.cliente]) || "(sem nome)";
        mapa.set(cliente, (mapa.get(cliente) || 0) + valor);
      });

      const entries = Array.from(mapa.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 12); // top 12

      const labels = entries.map((e) => e[0]);
      const data = entries.map((e) => e[1]);

      const ctx = document.getElementById("chart-batalha").getContext("2d");
      if (chartBatalha) chartBatalha.destroy();

      chartBatalha = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Oportunidade (por aluno)",
              data,
              borderWidth: 1.5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: (v) => formatCurrencyBR(v),
              },
            },
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const valor = context.parsed.y || 0;
                  return formatCurrencyBR(valor);
                },
              },
            },
          },
        },
      });
    }

    // ================== RESULTADOS UPS/RENOV ==================
    function updateResultados() {
      if (!FIELDS.tipoVenda || !FIELDS.valorVenda || !FIELDS.mesChurn) {
        if (chartResultados) chartResultados.destroy();
        const ctx = document.getElementById("chart-resultados").getContext("2d");
        chartResultados = new Chart(ctx, {
          type: "bar",
          data: { labels: [], datasets: [] },
        });
        resumoResultados.textContent =
          "Colunas obrigat√≥rias (tipo, valor, m√™s) n√£o foram localizadas.";
        return;
      }

      // mapa: mes -> { upsell: total, renov: total }
      const mapa = new Map();
      filteredData.forEach((row) => {
        const tipo = normalizeFieldName(row[FIELDS.tipoVenda] || "");
        const mes = (row[FIELDS.mesChurn] || "").toString().trim() || "(sem m√™s)";
        const valor = toNumber(row[FIELDS.valorVenda]);

        if (!mapa.has(mes)) {
          mapa.set(mes, { upsell: 0, renov: 0 });
        }

        const bucket = mapa.get(mes);
        if (tipo.includes("upsell")) {
          bucket.upsell += valor;
        } else if (tipo.includes("renov")) {
          bucket.renov += valor;
        }
      });

      const entries = Array.from(mapa.entries()).sort((a, b) =>
        a[0].localeCompare(b[0])
      );

      const labels = entries.map((e) => e[0]);
      const upsellData = entries.map((e) => e[1].upsell);
      const renovData = entries.map((e) => e[1].renov);

      const ctx = document.getElementById("chart-resultados").getContext("2d");
      if (chartResultados) chartResultados.destroy();

      chartResultados = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Upsell",
              data: upsellData,
              borderWidth: 1.5,
            },
            {
              label: "Renova√ß√£o",
              data: renovData,
              borderWidth: 1.5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: (v) => formatCurrencyBR(v),
              },
            },
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: (context) => {
                  const valor = context.parsed.y || 0;
                  return `${context.dataset.label}: ${formatCurrencyBR(valor)}`;
                },
              },
            },
          },
        },
      });

      // resumo
      const totalUpsell = upsellData.reduce((a, b) => a + b, 0);
      const totalRenov = renovData.reduce((a, b) => a + b, 0);
      const totalNegocios = filteredData.filter((row) =>
        toNumber(row[FIELDS.valorVenda]) > 0
      ).length;

      resumoResultados.innerHTML = `
        <strong>${totalNegocios}</strong> neg√≥cio(s) registrados na aba Vendas/Renova√ß√µes. 
        Upsell faturado: <strong>${formatCurrencyBR(totalUpsell)}</strong> |
        Renova√ß√£o faturada: <strong>${formatCurrencyBR(totalRenov)}</strong>.
      `;
    }

    // ================== TABELA CS (MAPA RISCO) ==================
    function updateCsTable() {
      csTableBody.innerHTML = "";

      if (!FIELDS.risco || !FIELDS.cliente) {
        csTableBody.innerHTML = `
          <tr><td colspan="7" class="loading">
            Colunas m√≠nimas para o mapa de risco (cliente / risco) n√£o foram localizadas.
          </td></tr>`;
        return;
      }

      // Crit√©rio simples: alunos com risco ‚â† "saud√°vel" (case-insensitive)
      const linhasCriticas = filteredData.filter((row) => {
        const riscoRaw = (row[FIELDS.risco] || "").toString().trim();
        const riscoNorm = normalizeFieldName(riscoRaw);
        return riscoNorm && !riscoNorm.includes("saudavel");
      });

      if (!linhasCriticas.length) {
        csTableBody.innerHTML = `
          <tr><td colspan="7" class="loading">
            Nenhum aluno em situa√ß√£o de risco com os filtros atuais.
          </td></tr>`;
        return;
      }

      linhasCriticas.forEach((row) => {
        const cliente = (row[FIELDS.cliente] || "").toString().trim() || "‚Äî";
        const plano = (FIELDS.plano && row[FIELDS.plano]) || "‚Äî";
        const avanco = (FIELDS.avanco && row[FIELDS.avanco]) || "‚Äî";
        const prazo = (FIELDS.prazo && row[FIELDS.prazo]) || "‚Äî";
        const riscoRaw = (row[FIELDS.risco] || "").toString().trim() || "‚Äî";
        const prest = (FIELDS.prestacao && row[FIELDS.prestacao]) || "‚Äî";
        const oportunidade = FIELDS.oportunidade
          ? formatCurrencyBR(toNumber(row[FIELDS.oportunidade]))
          : "‚Äî";

        const riscoNorm = normalizeFieldName(riscoRaw);
        let riscoClass = "outro";
        let riscoIcon = "‚è≥";
        if (riscoNorm.includes("alto")) {
          riscoClass = "alto-risco";
          riscoIcon = "‚ö†Ô∏è";
        } else if (riscoNorm.includes("saudavel")) {
          riscoClass = "saudavel";
          riscoIcon = "üü¢";
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><a href="#" style="color:#2563eb;text-decoration:underline;">${cliente}</a></td>
          <td>${plano}</td>
          <td>${avanco}</td>
          <td>${prazo}</td>
          <td>
            <span class="pill-status ${riscoClass}">
              <span class="dot"></span>
              <span>${riscoIcon} ${riscoRaw}</span>
            </span>
          </td>
          <td>${prest}</td>
          <td>${oportunidade}</td>
        `;
        csTableBody.appendChild(tr);
      });
    }

    // ================== ERROS ==================
    function showError(msg) {
      errorContainer.textContent = msg;
    }

    // ================== EVENTOS ==================
    mesChurnSelect.addEventListener("change", applyFilters);
    riscoSelect.addEventListener("change", applyFilters);
    resetButton.addEventListener("click", () => {
      if (!mesChurnSelect.disabled) mesChurnSelect.value = "";
      if (!riscoSelect.disabled) riscoSelect.value = "";
      applyFilters();
    });

    document.addEventListener("DOMContentLoaded", loadCSV);
  </script>
</body>
</html>

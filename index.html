<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>GO Educação – Dashboard CS</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --cs-navy: #0A1A2F;
      --cs-blue: #1F73B7;
      --cs-yellow: #C8A300;
      --cs-black: #000000;
      --cs-white: #FFFFFF;
      --cs-bg: #F5F6FA;
      --cs-gray: #E3E6ED;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
                   "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--cs-bg);
      color: var(--cs-black);
    }

    .topbar {
      background: linear-gradient(135deg, var(--cs-navy), var(--cs-blue));
      color: var(--cs-white);
      padding: 18px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }

    .topbar-inner {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .topbar-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .topbar-title h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .topbar-title span {
      font-size: 13px;
      opacity: 0.9;
    }

    .topbar-badge {
      background: rgba(255,255,255,0.12);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .topbar-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #20c997;
    }

    .page {
      max-width: 1280px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    .loading {
      font-size: 13px;
      color: #555;
      margin-top: 8px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin: 24px 0 10px;
      color: var(--cs-navy);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title span.icon {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      background: var(--cs-yellow);
      display: inline-block;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }

    .kpi-card {
      background: var(--cs-white);
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border: 1px solid #D8DCE8;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .kpi-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #7A8194;
    }

    .kpi-value {
      font-size: 22px;
      font-weight: 600;
      color: var(--cs-black);
    }

    .kpi-extra {
      font-size: 11px;
      color: #7A8194;
    }

    .kpi-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 8px;
      align-self: flex-start;
    }

    .tag-ok {
      background: rgba(31, 199, 116, 0.12);
      color: #158152;
    }

    .tag-warning {
      background: rgba(255, 193, 7, 0.15);
      color: #947000;
    }

    .tag-risk {
      background: rgba(220, 53, 69, 0.14);
      color: #A32035;
    }
</style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="topbar-title">
        <h1>GO Educação – Dashboard CS</h1>
        <span>Acompanhamento de jornada, engajamento e oportunidades</span>
      </div>

      <div class="topbar-badge">
        <span class="topbar-dot"></span> Dados carregados do Google Sheets (CSV)
      </div>
    </div>
  </header>

  <main class="page">
    <div id="loading-global" class="loading">
      Carregando dados das abas (Jornada, Prestação, Experience, Batalha Naval)...
    </div>

    <!-- KPIs -->
    <h2 class="section-title"><span class="icon"></span>Visão Geral</h2>

    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Alunos ativos</div>
        <div class="kpi-value" id="kpi-total-alunos">–</div>
        <div class="kpi-extra" id="kpi-total-alunos-extra"></div>
        <div class="kpi-tag tag-ok">Base atual da mentoria</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Taxa de sucesso da jornada</div>
        <div class="kpi-value" id="kpi-taxasucesso">–</div>
        <div class="kpi-extra" id="kpi-taxasucesso-extra"></div>
        <div class="kpi-tag tag-ok">Conclusão da Trilha</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Prestação de contas em dia</div>
        <div class="kpi-value" id="kpi-prestacao">–</div>
        <div class="kpi-extra" id="kpi-prestacao-extra"></div>
        <div class="kpi-tag tag-warning">Envio dos dados mensais</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Potencial de oportunidades</div>
        <div class="kpi-value" id="kpi-oportunidades">–</div>
        <div class="kpi-extra" id="kpi-oportunidades-extra"></div>
        <div class="kpi-tag tag-risk">Upsell / Renovação</div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters-row" style="margin-top: 22px;">
      <div class="filter-group">
        <label for="filter-plano">Plano (Jornada)</label>
        <select id="filter-plano">
          <option value="__all__">Todos os planos</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filter-exp-mes">Mês (Experience)</label>
        <select id="filter-exp-mes">
          <option value="__all__">Todos os meses</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filter-exp-encontro">Encontro (Experience)</label>
        <select id="filter-exp-encontro">
          <option value="__all__">Todos os encontros</option>
        </select>
      </div>
    </div>

    <!-- Gráficos principais -->
    <div class="layout-two">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Avanço da jornada por aluno</div>
            <div class="card-subtitle">Percentual de conclusão baseado na trilha.</div>
          </div>
          <span class="pill">Jornada</span>
        </div>

        <canvas id="chart-avanco"></canvas>

        <div class="legend">
          <span class="legend-item">
            <span class="legend-dot" style="background: var(--cs-blue);"></span>
            Avanço individual (%)
          </span>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Distribuição de risco de churn</div>
            <div class="card-subtitle">Análise de saúde da base.</div>
          </div>
          <span class="pill">Churn</span>
        </div>

        <canvas id="chart-churn"></canvas>
      </div>
    </div>

    <!-- Linha 2 -->
    <div class="layout-three" style="margin-top: 24px;">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Prestação de contas</div>
            <div class="card-subtitle">Envios mensais dos dados financeiros</div>
          </div>
          <span class="pill">Financeiro</span>
        </div>

        <canvas id="chart-prestacao"></canvas>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Oportunidades – Batalha Naval</div>
            <div class="card-subtitle">Valor potencial por aluno</div>
          </div>
          <span class="pill">Oportunidades</span>
        </div>

        <canvas id="chart-oportunidades"></canvas>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Engajamento – Let's GO Experience</div>
            <div class="card-subtitle">Participações, confirmações e interações</div>
          </div>
          <span class="pill">Experience</span>
        </div>

        <div id="experience-summary" style="font-size: 12px; color: #444;"></div>
      </div>
    </div>

    <!-- Tabela alunos que precisam de atenção -->
    <h2 class="section-title"><span class="icon"></span>Alunos em Atenção</h2>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Mapa de Risco + Oportunidades</div>
          <div class="card-subtitle">
            Clique no nome do aluno para abrir o painel individual
          </div>
        </div>
        <span class="pill">Prioridade</span>
      </div>

      <table class="attention-table">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Plano</th>
            <th>Avanço</th>
            <th>Prazo</th>
            <th>Risco</th>
            <th>Prestação</th>
            <th>Oportunidade</th>
          </tr>
        </thead>

        <tbody id="attention-body"></tbody>
      </table>
    </div>
<script>
/* ===============================
   URLs das abas (CSV)
================================*/
const URL_JORNADA     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=3760243&single=true&output=csv";
const URL_PRESTACAO   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=997833295&single=true&output=csv";
const URL_EXPERIENCE  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=0&single=true&output=csv";
const URL_BATALHA     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=569915638&single=true&output=csv";

/* ===============================
   Estado Global
================================*/
let allJornada = [];
let allPrest = [];
let allBnav = [];
let allExp = [];

/* Filtros selecionados pelo usuário */
let currentPlanoFilter = "__all__";
let currentExpMesFilter = "__all__";
let currentExpEncontroFilter = "__all__";

/* Instâncias dos gráficos */
let chartAvanco      = null;
let chartChurn       = null;
let chartPrestacao   = null;
let chartOportunidades = null;

/* ===============================
   Funções auxiliares
================================*/

/* Converte CSV para array de objetos */
function parseCsv(text) {
  const lines = text.trim().split(/\r?\n/);
  const header = lines.shift().split(",");

  return lines.map((line) => {
    const cols = line.split(",");
    const obj = {};
    header.forEach((h, i) => {
      obj[h.trim()] = (cols[i] || "").trim();
    });
    return obj;
  });
}

function parsePercentString(str) {
  if (!str) return 0;
  let clean = str.replace("%", "").replace(",", ".").trim();
  let n = parseFloat(clean);
  return isNaN(n) ? 0 : n;
}

function parseNumberBR(str) {
  if (!str) return 0;
  return Number(str.replace(/\./g, "").replace(",", ".").replace(/[^\d.-]/g, "")) || 0;
}

function formatPercent(v) {
  return (v || 0).toFixed(1).replace(".", ",") + "%";
}

function formatCurrencyBRL(v) {
  return (v || 0).toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL",
  });
}

/* ===============================
   Fetch wrapper
================================*/
async function fetchCsv(url) {
  const res = await fetch(url);
  const txt = await res.text();
  return parseCsv(txt);
}

/* ===============================
   Normalização dos dados
================================*/

/* Jornada */
function normalizeJornada(rows) {
  if (!rows.length) return [];

  const headers = Object.keys(rows[0]);

  const hCliente = headers.find((h) => /cliente/i.test(h));
  const hPlano = headers.find((h) => /plano/i.test(h));
  const hAvanco = headers.find((h) => /avanç|avan|trilha|%/i.test(h));
  const hPrazo = headers.find((h) => /prazo|cronograma|atras/i.test(h));
  const hRisco = headers.find((h) => /churn|risco/i.test(h));
  const hStatusPlano = headers.find((h) => /status.*plano/i.test(h));

  return rows
    .filter((r) => (r[hCliente] || "").trim() !== "")
    .map((r) => ({
      cliente: r[hCliente] || "",
      plano: r[hPlano] || "",
      avancoPercent: parsePercentString(r[hAvanco] || ""),
      prazo: r[hPrazo] || "",
      riscoChurn: r[hRisco] || "",
      statusPlano: r[hStatusPlano] || "",
    }));
}

/* Prestação de contas */
function normalizePrestacao(rows) {
  if (!rows.length) return [];
  const headers = Object.keys(rows[0]);

  const hCliente = headers.find((h) => /cliente/i.test(h));
  const hSituacao = headers.find((h) => /situa/i.test(h));

  return rows
    .filter((r) => (r[hCliente] || "").trim() !== "")
    .map((r) => ({
      cliente: r[hCliente] || "",
      situacaoAtual: r[hSituacao] || "",
    }));
}

/* Batalha Naval */
function normalizeBatalha(rows) {
  if (!rows.length) return [];
  const headers = Object.keys(rows[0]);

  const hCliente = headers.find((h) => /aluno|cliente/i.test(h));
  const hTotal = headers.find((h) => /total/i.test(h));

  return rows
    .filter((r) => (r[hCliente] || "").trim() !== "")
    .map((r) => ({
      cliente: r[hCliente] || "",
      oportunidadeTotal: parseNumberBR(r[hTotal] || "0"),
    }));
}

/* Let's Go Experience */
function normalizeExperience(rows) {
  if (!rows.length) return [];
  const headers = Object.keys(rows[0]);

  const hMes = headers.find((h) => /m[eê]s/i.test(h));
  const hEncontro = headers.find((h) => /encontro/i.test(h));
  const hAluno = headers.find((h) => /aluno|cliente/i.test(h));
  const hStatus = headers.find((h) => /status/i.test(h));

  return rows.map((r) => ({
    mes: r[hMes] || "",
    encontro: r[hEncontro] || "",
    aluno: r[hAluno] || "",
    status: r[hStatus] || "",
  }));
}

/* ===============================
   FILTROS
================================*/

function getFilteredJornada() {
  if (currentPlanoFilter === "__all__") return allJornada;
  return allJornada.filter(
    (j) => j.plano.toLowerCase() === currentPlanoFilter.toLowerCase()
  );
}

function getFilteredExperience() {
  return allExp.filter((e) => {
    let ok = true;
    if (currentExpMesFilter !== "__all__") {
      ok = ok && e.mes.toLowerCase() === currentExpMesFilter.toLowerCase();
    }
    if (currentExpEncontroFilter !== "__all__") {
      ok = ok && e.encontro.toLowerCase() === currentExpEncontroFilter.toLowerCase();
    }
    return ok;
  });
}

/* ===============================
   KPIs
================================*/
function buildKPIs(jornada, prest, bnav) {
  const total = jornada.length;

  const concluidos = jornada.filter((j) =>
    (j.statusPlano || "").toLowerCase().includes("final")
  ).length;

  const taxaSucesso = total ? (concluidos / total) * 100 : 0;

  /* Prestação em dia */
  const prestMap = {};
  prest.forEach((p) => (prestMap[p.cliente] = p.situacaoAtual));

  let emDia = 0;
  jornada.forEach((j) => {
    const s = prestMap[j.cliente]?.toLowerCase() || "";
    if (s.includes("preenchido")) {
      emDia++;
    }
  });

  const taxaPrestacao = total ? (emDia / total) * 100 : 0;

  /* Oportunidades */
  const totalOportunidades = bnav.reduce(
    (acc, cur) => acc + cur.oportunidadeTotal,
    0
  );

  document.getElementById("kpi-total-alunos").textContent = total;
  document.getElementById("kpi-total-alunos-extra").textContent =
    `${concluidos} já finalizaram.`;

  document.getElementById("kpi-taxasucesso").textContent =
    formatPercent(taxaSucesso);
  document.getElementById("kpi-taxasucesso-extra").textContent =
    `Média geral da trilha.`;

  document.getElementById("kpi-prestacao").textContent =
    formatPercent(taxaPrestacao);
  document.getElementById("kpi-prestacao-extra").textContent =
    `${emDia} de ${total} em dia.`;

  document.getElementById("kpi-oportunidades").textContent =
    formatCurrencyBRL(totalOportunidades);
  document.getElementById("kpi-oportunidades-extra").textContent =
    `Baseado em SIMs da Batalha Naval.`;
}

/* ===============================
   GRÁFICOS
================================*/

function buildAvancoChart(jornada) {
  const ctx = document.getElementById("chart-avanco").getContext("2d");
  if (chartAvanco) chartAvanco.destroy();

  chartAvanco = new Chart(ctx, {
    type: "bar",
    data: {
      labels: jornada.map((j) => j.cliente),
      datasets: [
        {
          label: "Avanço (%)",
          data: jornada.map((j) => j.avancoPercent),
          backgroundColor: "rgba(31, 115, 183, .8)",
          borderColor: "#1F73B7",
          borderWidth: 1,
          borderRadius: 8,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          max: 100,
          beginAtZero: true,
          ticks: {
            callback: (v) => v + "%",
          },
        },
      },
    },
  });
}

function buildChurnChart(jornada) {
  const ctx = document.getElementById("chart-churn").getContext("2d");
  if (chartChurn) chartChurn.destroy();

  const counts = {};
  jornada.forEach((j) => {
    counts[j.riscoChurn] = (counts[j.riscoChurn] || 0) + 1;
  });

  const labels = Object.keys(counts);
  const data = Object.values(counts);

  const colors = labels.map((l) => {
    l = l.toLowerCase();
    if (l.includes("alto")) return "#CC3333";
    if (l.includes("moderado")) return "#C8A300";
    if (l.includes("saud")) return "#2ECC71";
    if (l.includes("concl")) return "#1F73B7";
    return "#0A1A2F";
  });

  chartChurn = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels,
      datasets: [
        {
          data,
          backgroundColor: colors,
        },
      ],
    },
    options: {
      cutout: "55%",
      plugins: { legend: { position: "bottom" } },
    },
  });
}

function buildPrestacaoChart(jornada, prest) {
  const ctx = document.getElementById("chart-prestacao").getContext("2d");
  if (chartPrestacao) chartPrestacao.destroy();

  const prestMap = {};
  prest.forEach((p) => (prestMap[p.cliente] = p.situacaoAtual));

  let emDia = 0;
  jornada.forEach((j) => {
    const s = prestMap[j.cliente]?.toLowerCase() || "";
    if (s.includes("preenchido")) emDia++;
  });

  const nao = jornada.length - emDia;

  chartPrestacao = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Em dia", "Em atraso"],
      datasets: [
        {
          data: [emDia, nao],
          backgroundColor: ["#158152", "#A32035"],
        },
      ],
    },
    options: {
      cutout: "55%",
      plugins: { legend: { position: "bottom" } },
    },
  });
}

function buildOportunidadesChart(bnav) {
  const ctx = document.getElementById("chart-oportunidades").getContext("2d");
  if (chartOportunidades) chartOportunidades.destroy();

  const alunosComOp = bnav.filter((b) => b.oportunidadeTotal > 0);

  chartOportunidades = new Chart(ctx, {
    type: "bar",
    data: {
      labels: alunosComOp.map((b) => b.cliente),
      datasets: [
        {
          label: "Oportunidade (R$)",
          data: alunosComOp.map((b) => b.oportunidadeTotal),
          backgroundColor: "rgba(200, 163, 0, .75)",
          borderColor: "#C8A300",
          borderRadius: 8,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: (v) => formatCurrencyBRL(v),
          },
        },
      },
    },
  });
}
</script>
<script>
/* ===============================
   EXPERIENCE SUMMARY
================================*/
function buildExperienceSummary(expData) {
  const container = document.getElementById("experience-summary");

  if (!expData.length) {
    container.innerHTML = "Nenhum dado para os filtros selecionados.";
    return;
  }

  const total = expData.length;
  const confirmados = expData.filter((e) =>
    (e.status || "").toLowerCase().includes("confirm")
  ).length;

  container.innerHTML = `
    <p><strong>${total}</strong> registros encontrados.</p>
    <p><strong>${confirmados}</strong> confirmações de presença.</p>
  `;
}

/* ===============================
   TABELA DE ATENÇÃO
================================*/
function buildAttentionTable(jornada, prest, bnav) {
  const tbody = document.getElementById("attention-body");
  tbody.innerHTML = "";

  const prestMap = {};
  prest.forEach((p) => (prestMap[p.cliente] = p.situacaoAtual));

  const bnavMap = {};
  bnav.forEach((b) => (bnavMap[b.cliente] = b.oportunidadeTotal));

  jornada.forEach((j) => {
    const cliente = j.cliente;
    const prestacao = prestMap[cliente] || "";
    const oportunidade = bnavMap[cliente] || 0;
    const atrasado =
      (prestacao || "").toLowerCase().includes("não") ||
      (prestacao || "").toLowerCase().includes("⚠️");
    const risco = j.riscoChurn.toLowerCase();

    const precisaAtencao =
      risco.includes("alto") ||
      risco.includes("moderado") ||
      j.avancoPercent < 50 ||
      atrasado ||
      oportunidade > 0;

    if (!precisaAtencao) return;

    const tr = document.createElement("tr");

    /* Nome clicável (abre modal) */
    const tdCliente = document.createElement("td");
    tdCliente.textContent = cliente;
    tdCliente.classList.add("link-cliente");
    tdCliente.addEventListener("click", () => openAlunoModal(cliente));
    tr.appendChild(tdCliente);

    /* Plano */
    const tdPlano = document.createElement("td");
    tdPlano.textContent = j.plano;
    tr.appendChild(tdPlano);

    /* Avanço */
    const tdAvanco = document.createElement("td");
    tdAvanco.textContent = formatPercent(j.avancoPercent);
    tr.appendChild(tdAvanco);

    /* Prazo */
    const tdPrazo = document.createElement("td");
    tdPrazo.textContent = j.prazo || "–";
    tr.appendChild(tdPrazo);

    /* Risco */
    const tdRisco = document.createElement("td");
    tdRisco.textContent = j.riscoChurn;
    tr.appendChild(tdRisco);

    /* Prestação */
    const tdPrest = document.createElement("td");
    tdPrest.textContent = prestacao || "–";
    tr.appendChild(tdPrest);

    /* Oportunidade */
    const tdOp = document.createElement("td");
    tdOp.textContent = oportunidade > 0 ? formatCurrencyBRL(oportunidade) : "–";
    tr.appendChild(tdOp);

    tbody.appendChild(tr);
  });
}

/* ===============================
   MODAL INDIVIDUAL
================================*/
function openAlunoModal(cliente) {
  const modalOverlay = document.getElementById("aluno-modal-overlay");
  const modalContent = document.getElementById("modal-content");

  const j = allJornada.find((x) => x.cliente === cliente);
  const prest = allPrest.find((x) => x.cliente === cliente);
  const bnav = allBnav.find((x) => x.cliente === cliente);
  const expList = allExp.filter((x) => x.aluno === cliente);

  modalContent.innerHTML = `
    <div class="modal-header">
      <h2>${cliente}</h2>
      <span>${j ? j.plano : "Sem plano"}</span>
    </div>

    <div class="modal-grid">
      <div class="modal-block">
        <h3>Jornada</h3>
        <p><strong>Avanço:</strong> ${formatPercent(j.avancoPercent)}</p>
        <p><strong>Prazo:</strong> ${j.prazo}</p>
        <p><strong>Risco:</strong> ${j.riscoChurn}</p>
      </div>

      <div class="modal-block">
        <h3>Prestação</h3>
        <p><strong>Situação atual:</strong> ${
          prest ? prest.situacaoAtual : "–"
        }</p>
      </div>
    </div>

    <div class="modal-grid" style="margin-top: 8px;">
      <div class="modal-block">
        <h3>Oportunidades (Batalha Naval)</h3>
        <p><strong>Total:</strong> ${
          bnav ? formatCurrencyBRL(bnav.oportunidadeTotal) : "R$ 0,00"
        }</p>
      </div>

      <div class="modal-block">
        <h3>Let's GO Experience</h3>
        <p><strong>Registros:</strong> ${expList.length}</p>
        <p><strong>Confirmados:</strong> ${
          expList.filter((x) =>
            (x.status || "").toLowerCase().includes("confirm")
          ).length
        }</p>
      </div>
    </div>
  `;

  modalOverlay.classList.remove("hidden");
}

/* Fechar o modal */
document.getElementById("modal-close-btn").addEventListener("click", () => {
  document.getElementById("aluno-modal-overlay").classList.add("hidden");
});

/* ===============================
   RENDERIZAÇÃO COMPLETA
================================*/
function renderAll() {
  const jornadaFiltrada = getFilteredJornada();
  const expFiltrada = getFilteredExperience();

  buildKPIs(jornadaFiltrada, allPrest, allBnav);
  buildAvancoChart(jornadaFiltrada);
  buildChurnChart(jornadaFiltrada);
  buildPrestacaoChart(jornadaFiltrada, allPrest);
  buildOportunidadesChart(allBnav);
  buildExperienceSummary(expFiltrada);
  buildAttentionTable(jornadaFiltrada, allPrest, allBnav);
}

/* ===============================
   CARREGAMENTO INICIAL
================================*/
async function loadAllData() {
  try {
    const [jornadaRows, prestRows, expRows, batalhaRows] = await Promise.all([
      fetchCsv(URL_JORNADA),
      fetchCsv(URL_PRESTACAO),
      fetchCsv(URL_EXPERIENCE),
      fetchCsv(URL_BATALHA),
    ]);

    allJornada = normalizeJornada(jornadaRows);
    allPrest = normalizePrestacao(prestRows);
    allExp = normalizeExperience(expRows);
    allBnav = normalizeBatalha(batalhaRows);

    document.getElementById("loading-global").textContent =
      "Dados carregados com sucesso.";

    initFilters();
    renderAll();
  } catch (err) {
    console.error("Erro ao carregar dados:", err);
    document.getElementById("loading-global").textContent =
      "ERRO: Verifique se as abas estão publicadas como CSV.";
  }
}

/* ===============================
   INICIALIZA FILTROS
================================*/
function initFilters() {
  const planos = [...new Set(allJornada.map((j) => j.plano))].filter(Boolean);
  const meses = [...new Set(allExp.map((e) => e.mes))].filter(Boolean);
  const encontros = [...new Set(allExp.map((e) => e.encontro))].filter(Boolean);

  const fPlano = document.getElementById("filter-plano");
  planos.forEach((p) => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    fPlano.appendChild(opt);
  });

  fPlano.addEventListener("change", () => {
    currentPlanoFilter = fPlano.value;
    renderAll();
  });

  const fMes = document.getElementById("filter-exp-mes");
  meses.forEach((m) => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    fMes.appendChild(opt);
  });

  fMes.addEventListener("change", () => {
    currentExpMesFilter = fMes.value;
    renderAll();
  });

  const fEncontro = document.getElementById("filter-exp-encontro");
  encontros.forEach((e) => {
    const opt = document.createElement("option");
    opt.value = e;
    opt.textContent = e;
    fEncontro.appendChild(opt);
  });

  fEncontro.addEventListener("change", () => {
    currentExpEncontroFilter = fEncontro.value;
    renderAll();
  });
}

/* ===============================
   START
================================*/
loadAllData();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>GO Educação – Dashboard CS</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --cs-navy: #0A1A2F;
      --cs-blue: #1F73B7;
      --cs-yellow: #C8A300;
      --cs-black: #000000;
      --cs-white: #FFFFFF;
      --cs-bg: #F5F6FA;
      --cs-gray: #E3E6ED;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
                   "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--cs-bg);
      color: var(--cs-black);
    }

    .topbar {
      background: linear-gradient(135deg, var(--cs-navy), var(--cs-blue));
      color: var(--cs-white);
      padding: 18px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }

    .topbar-inner {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .topbar-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .topbar-title h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .topbar-title span {
      font-size: 13px;
      opacity: 0.9;
    }

    .topbar-badge {
      background: rgba(255,255,255,0.12);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .topbar-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #20c997;
    }

    .page {
      max-width: 1280px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    .loading {
      font-size: 13px;
      color: #555;
      margin-top: 8px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin: 24px 0 10px;
      color: var(--cs-navy);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title span.icon {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      background: var(--cs-yellow);
      display: inline-block;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }

    .kpi-card {
      background: var(--cs-white);
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border: 1px solid #D8DCE8;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .kpi-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #7A8194;
    }

    .kpi-value {
      font-size: 22px;
      font-weight: 600;
      color: var(--cs-black);
    }

    .kpi-extra {
      font-size: 11px;
      color: #7A8194;
    }

    .kpi-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 8px;
      align-self: flex-start;
    }

    .tag-ok {
      background: rgba(31, 199, 116, 0.12);
      color: #158152;
    }

    .tag-warning {
      background: rgba(255, 193, 7, 0.15);
      color: #947000;
    }

    .tag-risk {
      background: rgba(220, 53, 69, 0.14);
      color: #A32035;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="topbar-title">
        <h1>GO Educação – Dashboard CS</h1>
        <span>Acompanhamento de jornada, engajamento e oportunidades</span>
      </div>

      <div class="topbar-badge">
        <span class="topbar-dot"></span> Dados carregados do Google Sheets (CSV)
      </div>
    </div>
  </header>

  <main class="page">
    <div id="loading-global" class="loading">
      Carregando dados das abas (Jornada, Prestação, Experience, Batalha Naval)...
    </div>

    <!-- KPIs -->
    <h2 class="section-title"><span class="icon"></span>Visão Geral</h2>

    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Alunos ativos</div>
        <div class="kpi-value" id="kpi-total-alunos">–</div>
        <div class="kpi-extra" id="kpi-total-alunos-extra"></div>
        <div class="kpi-tag tag-ok">Base atual da mentoria</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Taxa de sucesso da jornada</div>
        <div class="kpi-value" id="kpi-taxasucesso">–</div>
        <div class="kpi-extra" id="kpi-taxasucesso-extra"></div>
        <div class="kpi-tag tag-ok">Conclusão da Trilha</div>
      </div>
<script>
/* ===============================
   URLs das abas (CSV)
================================*/
const URL_JORNADA     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=3760243&single=true&output=csv";
const URL_PRESTACAO   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=997833295&single=true&output=csv";
const URL_EXPERIENCE  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=0&single=true&output=csv";
const URL_BATALHA     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=569915638&single=true&output=csv";

/* ===============================
   Estado Global
================================*/
let allJornada = [];
let allPrest = [];
let allBnav = [];
let allExp = [];

/* Filtros selecionados pelo usuário */
let currentPlanoFilter = "__all__";
let currentExpMesFilter = "__all__";
let currentExpEncontroFilter = "__all__";

/* Instâncias dos gráficos */
let chartAvanco      = null;
let chartChurn       = null;
let chartPrestacao   = null;
let chartOportunidades = null;

/* ===============================
   Funções auxiliares
================================*/

/* Converte CSV para array de objetos */
function parseCsv(text) {
  const lines = text.trim().split(/\r?\n/);
  const header = lines.shift().split(",");

  return lines.map((line) => {
    const cols = line.split(",");
    const obj = {};
    header.forEach((h, i) => {
      obj[h.trim()] = (cols[i] || "").trim();
    });
    return obj;
  });
}

function parsePercentString(str) {
  if (!str) return 0;
  let clean = str.replace("%", "").replace(",", ".").trim();
  let n = parseFloat(clean);
  return isNaN(n) ? 0 : n;
}

function parseNumberBR(str) {
  if (!str) return 0;
  return Number(str.replace(/\./g, "").replace(",", ".").replace(/[^\d.-]/g, "")) || 0;
}

function formatPercent(v) {
  return (v || 0).toFixed(1).replace(".", ",") + "%";
}

function formatCurrencyBRL(v) {
  return (v || 0).toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL",
  });
}

/* ===============================
   Fetch wrapper
================================*/
async function fetchCsv(url) {
  const res = await fetch(url);
  const txt = await res.text();
  return parseCsv(txt);
}

/* ===============================
   Normalização dos dados
================================*/

/* Jornada */
function normalizeJornada(rows) {
  if (!rows.length) return [];

  const headers = Object.keys(rows[0]);

  const hCliente = headers.find((h) => /cliente/i.test(h));
  const hPlano = headers.find((h) => /plano/i.test(h));
  const hAvanco = headers.find((h) => /avanç|avan|trilha|%/i.test(h));
  const hPrazo = headers.find((h) => /prazo|cronograma|atras/i.test(h));
  const hRisco = headers.find((h) => /churn|risco/i.test(h));
  const hStatusPlano = headers.find((h) => /status.*plano/i.test(h));

  return rows
    .filter((r) => (r[hCliente] || "").trim() !== "")
    .map((r) => ({
      cliente: r[hCliente] || "",
      plano: r[hPlano] || "",
      avancoPercent: parsePercentString(r[hAvanco] || ""),
      prazo: r[hPrazo] || "",
      riscoChurn: r[hRisco] || "",
      statusPlano: r[hStatusPlano] || "",
    }));
}

/* Prestação de contas */
function normalizePrestacao(rows) {
  if (!rows.length) return [];
  const headers = Object.keys(rows[0]);

  const hCliente = headers.find((h) => /cliente/i.test(h));
  const hSituacao = headers.find((h) => /situa/i.test(h));

  return rows
    .filter((r) => (r[hCliente] || "").trim() !== "")
    .map((r) => ({
      cliente: r[hCliente] || "",
      situacaoAtual: r[hSituacao] || "",
    }));
}

/* Batalha Naval */
function normalizeBatalha(rows) {
  if (!rows.length) return [];
  const headers = Object.keys(rows[0]);

  const hCliente = headers.find((h) => /aluno|cliente/i.test(h));
  const hTotal = headers.find((h) => /total/i.test(h));

  return rows
    .filter((r) => (r[hCliente] || "").trim() !== "")
    .map((r) => ({
      cliente: r[hCliente] || "",
      oportunidadeTotal: parseNumberBR(r[hTotal] || "0"),
    }));
}

/* Let's Go Experience */
function normalizeExperience(rows) {
  if (!rows.length) return [];
  const headers = Object.keys(rows[0]);

  const hMes = headers.find((h) => /m[eê]s/i.test(h));
  const hEncontro = headers.find((h) => /encontro/i.test(h));
  const hAluno = headers.find((h) => /aluno|cliente/i.test(h));
  const hStatus = headers.find((h) => /status/i.test(h));

  return rows.map((r) => ({
    mes: r[hMes] || "",
    encontro: r[hEncontro] || "",
    aluno: r[hAluno] || "",
    status: r[hStatus] || "",
  }));
}

/* ===============================
   FILTROS
================================*/

function getFilteredJornada() {
  if (currentPlanoFilter === "__all__") return allJornada;
  return allJornada.filter(
    (j) => j.plano.toLowerCase() === currentPlanoFilter.toLowerCase()
  );
}

function getFilteredExperience() {
  return allExp.filter((e) => {
    let ok = true;
    if (currentExpMesFilter !== "__all__") {
      ok = ok && e.mes.toLowerCase() === currentExpMesFilter.toLowerCase();
    }
    if (currentExpEncontroFilter !== "__all__") {
      ok = ok && e.encontro.toLowerCase() === currentExpEncontroFilter.toLowerCase();
    }
    return ok;
  });
}

/* ===============================
   KPIs
================================*/
function buildKPIs(jornada, prest, bnav) {
  const total = jornada.length;

  const concluidos = jornada.filter((j) =>
    (j.statusPlano || "").toLowerCase().includes("final")
  ).length;

  const taxaSucesso = total ? (concluidos / total) * 100 : 0;

  /* Prestação em dia */
  const prestMap = {};
  prest.forEach((p) => (prestMap[p.cliente] = p.situacaoAtual));

  let emDia = 0;
  jornada.forEach((j) => {
    const s = prestMap[j.cliente]?.toLowerCase() || "";
    if (s.includes("preenchido")) {
      emDia++;
    }
  });

  const taxaPrestacao = total ? (emDia / total) * 100 : 0;

  /* Oportunidades */
  const totalOportunidades = bnav.reduce(
    (acc, cur) => acc + cur.oportunidadeTotal,
    0
  );

  document.getElementById("kpi-total-alunos").textContent = total;
  document.getElementById("kpi-total-alunos-extra").textContent =
    `${concluidos} já finalizaram.`;

  document.getElementById("kpi-taxasucesso").textContent =
    formatPercent(taxaSucesso);
  document.getElementById("kpi-taxasucesso-extra").textContent =
    `Média geral da trilha.`;

  document.getElementById("kpi-prestacao").textContent =
    formatPercent(taxaPrestacao);
  document.getElementById("kpi-prestacao-extra").textContent =
    `${emDia} de ${total} em dia.`;

  document.getElementById("kpi

      <div class="kpi-card">
        <div class="kpi



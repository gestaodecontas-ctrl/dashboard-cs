<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard CS - GO Educa√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #f4f4f7;
      --card: #ffffff;
      --primary: #6D3D4F;
      --primary-soft: #e7cfc4;
      --text-main: #2d2d2d;
      --text-soft: #555;
      --border-soft: #ddd;
      --radius: 18px;
      --shadow: 0 8px 20px rgba(0,0,0,0.06);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 24px;
      background: var(--bg);
      color: var(--text-main);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 24px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .header-title h1 {
      margin: 0;
      font-size: 1.8rem;
      color: var(--primary);
    }

    .header-title p {
      margin: 4px 0 0;
      color: var(--text-soft);
      font-size: 0.95rem;
    }

    .badge {
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px 18px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 12px;
    }

    .card-title {
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--primary);
      display: inline-block;
    }

    .card-subtitle {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .summary-item {
      border-radius: 14px;
      padding: 10px;
      border: 1px solid var(--border-soft);
      background: #fafafa;
    }

    .summary-label {
      font-size: 0.75rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 1.2rem;
      font-weight: 700;
    }

    .summary-tag {
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .status-extra {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 6px;
    }

    .status-extra strong {
      color: var(--primary);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: 20px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }

    .filter-btn {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-soft);
      background: #f9f9f9;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .filter-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .filter-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    }

    .chart-wrapper {
      position: relative;
      min-height: 260px;
    }

    .table-wrapper {
      max-height: 440px;
      overflow: auto;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      background: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f4f4f6;
      z-index: 1;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #f0f0f0;
      text-align: left;
      white-space: nowrap;
    }

    tbody tr:hover {
      background: #faf7f8;
    }

    .pill-status {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 0.7rem;
      font-weight: 600;
      display: inline-block;
    }

    .pill-ativo { background: #e5f6ed; color: #247a43; }
    .pill-atencao { background: #fff7e6; color: #8a5a00; }
    .pill-finalizado { background: #e6ecff; color: #3049a5; }
    .pill-vitoria { background: #fde6ff; color: #8a1f8f; }
    .pill-outros { background: #f0f0f0; color: #555; }

    .loading {
      font-size: 0.9rem;
      color: var(--text-soft);
      padding: 12px 0;
    }

    .error {
      color: #b00020;
      padding: 10px 0;
      font-size: 0.9rem;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-title">
        <h1>Dashboard CS ‚Äì Presta√ß√£o de Contas</h1>
        <p>Vis√£o de alunos por status de acompanhamento (Ativo, Aten√ß√£o CS, Finalizado, Vit√≥ria, etc.).</p>
      </div>
      <div class="badge">
        Dados ao vivo via CSV &bull; Clique no gr√°fico ou nos filtros
      </div>
    </header>

    <!-- RESUMO -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="dot"></span>
            Indicadores Gerais de CS
          </div>
          <p class="card-subtitle">
            Somente a coluna de status √© usada aqui. Nada de presta√ß√£o de contas 100% üòä
          </p>
        </div>
      </div>

      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Total de alunos (base CS)</div>
          <div class="summary-value" id="totalAlunos">-</div>
          <div class="summary-tag">100% da base</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Ativos</div>
          <div class="summary-value" id="ativosCount">-</div>
          <div class="summary-tag" id="ativosPerc">-</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Aten√ß√£o CS</div>
          <div class="summary-value" id="atencaoCount">-</div>
          <div class="summary-tag" id="atencaoPerc">-</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Finalizados / Encerrados</div>
          <div class="summary-value" id="finalizadosCount">-</div>
          <div class="summary-tag" id="finalizadosPerc">-</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Vit√≥rias</div>
          <div class="summary-value" id="vitoriasCount">-</div>
          <div class="summary-tag" id="vitoriasPerc">-</div>
        </div>
      </div>

      <div class="status-extra" id="statusHint">
        Vis√£o inicial mostra <strong>apenas Ativos e Aten√ß√£o CS</strong> na tabela.  
        Use os filtros ou clique no gr√°fico para ver Finalizados, Vit√≥rias ou Outros.
      </div>
    </section>

    <!-- GR√ÅFICO + TABELA -->
    <section class="grid">
      <!-- Gr√°fico -->
      <article class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="dot"></span>
              Alunos por status de CS
            </div>
            <p class="card-subtitle">
              Clique em um peda√ßo do gr√°fico ou use os bot√µes de filtro abaixo.
            </p>
          </div>
        </div>

        <div class="filters" id="filterButtons"></div>

        <div class="chart-wrapper">
          <canvas id="statusChart"></canvas>
        </div>

        <div id="chartLoading" class="loading">Carregando dados...</div>
        <div id="chartError" class="error" style="display:none;"></div>
      </article>

      <!-- Tabela -->
      <article class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="dot"></span>
              Detalhe dos alunos
            </div>
            <p class="card-subtitle" id="tableSubtitle">
              Exibindo: <strong>Vis√£o ativa (Ativos + Aten√ß√£o CS)</strong>.
            </p>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </article>
    </section>
  </div>

  <script>
    /************************************************************
     * CONFIGURA√á√ïES
     ************************************************************/
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=997833295&single=true&output=csv";

    // Poss√≠veis nomes da coluna de STATUS
    const POSSIBLE_STATUS_COLUMNS = [
      "Status", "STATUS",
      "Situa√ß√£o", "SITUA√á√ÉO",
      "Situacao", "SITUACAO",
      "Status CS", "STATUS CS",
      "Status Cs", "STATUS Cs"
    ];

    // Poss√≠veis nomes da coluna de NOME
    const POSSIBLE_NAME_COLUMNS = [
      "Nome", "NOME",
      "Aluno", "ALUNO",
      "Nome Aluno", "NOME ALUNO"
    ];

    /************************************************************
     * VARI√ÅVEIS GLOBAIS
     ************************************************************/
    let rawRows = [];
    let statusColumnName = null;
    let nameColumnName = null;
    let chartInstance = null;
    let currentFilter = "VisaoAtiva"; // vis√£o inicial: Ativo + Aten√ß√£o

    /************************************************************
     * FUN√á√ïES DE APOIO
     ************************************************************/
    function guessColumnName(columns, candidates) {
      for (const cand of candidates) {
        const found = columns.find(
          (c) => c.trim().toLowerCase() === cand.trim().toLowerCase()
        );
        if (found) return found;
      }
      return null;
    }

    function classifyStatus(statusRaw) {
      if (!statusRaw) return "Outros";
      const s = statusRaw.toString().trim().toLowerCase();

      // Vit√≥ria primeiro
      if (s.includes("vitor")) return "Vit√≥ria";

      // Ativo
      if (s.includes("ativo")) return "Ativo";

      // Aten√ß√£o CS
      if (s.includes("aten")) return "Aten√ß√£o CS";
      if (s.includes(" cs") || s.startsWith("cs") || s.includes("cs ")) {
        return "Aten√ß√£o CS";
      }

      // Finalizado / Encerrado
      if (s.includes("finaliz") || s.includes("encerr") || s.includes("conclu")) {
        return "Finalizado / Encerrado";
      }

      return "Outros";
    }

    function getPillClass(group) {
      switch (group) {
        case "Ativo":
          return "pill-ativo";
        case "Aten√ß√£o CS":
          return "pill-atencao";
        case "Finalizado / Encerrado":
          return "pill-finalizado";
        case "Vit√≥ria":
          return "pill-vitoria";
        default:
          return "pill-outros";
      }
    }

    function prettyPercent(value, total) {
      if (!total) return "0% da base";
      const perc = (value / total) * 100;
      return perc.toFixed(1).replace(".", ",") + "% da base";
    }

    function updateSummary(counts, total) {
      const ativos = counts["Ativo"] || 0;
      const atencao = counts["Aten√ß√£o CS"] || 0;
      const finalizados = counts["Finalizado / Encerrado"] || 0;
      const vitorias = counts["Vit√≥ria"] || 0;

      document.getElementById("totalAlunos").textContent = total || 0;
      document.getElementById("ativosCount").textContent = ativos;
      document.getElementById("atencaoCount").textContent = atencao;
      document.getElementById("finalizadosCount").textContent = finalizados;
      document.getElementById("vitoriasCount").textContent = vitorias;

      document.getElementById("ativosPerc").textContent =
        prettyPercent(ativos, total);
      document.getElementById("atencaoPerc").textContent =
        prettyPercent(atencao, total);
      document.getElementById("finalizadosPerc").textContent =
        prettyPercent(finalizados, total);
      document.getElementById("vitoriasPerc").textContent =
        prettyPercent(vitorias, total);
    }

    function buildTableHead(columns) {
      const thead = document.getElementById("tableHead");
      thead.innerHTML = "";
      const tr = document.createElement("tr");

      columns.forEach((col) => {
        const th = document.createElement("th");
        th.textContent = col;
        tr.appendChild(th);
      });

      thead.appendChild(tr);
    }

    function renderTable() {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";
      if (!rawRows.length) return;

      const columns = Object.keys(rawRows[0]);

      // legenda do filtro
      const subtitle = document.getElementById("tableSubtitle");
      if (currentFilter === "VisaoAtiva") {
        subtitle.innerHTML =
          'Exibindo: <strong>Vis√£o ativa (Ativos + Aten√ß√£o CS)</strong>.';
      } else if (currentFilter === "Todos") {
        subtitle.innerHTML = 'Exibindo: <strong>Todos</strong> os alunos.';
      } else {
        subtitle.innerHTML =
          'Exibindo alunos com status: <strong>' + currentFilter + "</strong>.";
      }

      // filtrar linhas
      let rowsToShow = rawRows.filter((row) => {
        const group = classifyStatus(row[statusColumnName]);

        if (currentFilter === "VisaoAtiva") {
          return group === "Ativo" || group === "Aten√ß√£o CS";
        }

        if (currentFilter === "Todos") {
          return true;
        }

        return group === currentFilter;
      });

      rowsToShow.forEach((row) => {
        const tr = document.createElement("tr");

        columns.forEach((col) => {
          const td = document.createElement("td");
          const value = row[col];

          if (col === statusColumnName) {
            const group = classifyStatus(value);
            const pill = document.createElement("span");
            pill.className = "pill-status " + getPillClass(group);
            pill.textContent = value || group;
            td.appendChild(pill);
          } else {
            td.textContent = value ?? "";
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }

    function renderChart(counts) {
      const ctx = document.getElementById("statusChart");

      const labels = Object.keys(counts).filter((k) => counts[k] > 0);
      const values = labels.map((l) => counts[l]);

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              data: values,
              backgroundColor: [
                "#6D3D4F",
                "#C9A86A",
                "#E7CFC4",
                "#2D2D2D",
                "#a2a2a2",
              ],
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                boxWidth: 16,
                usePointStyle: true,
              },
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const total = values.reduce((a, b) => a + b, 0);
                  const val = ctx.parsed;
                  const perc = total ? (val / total) * 100 : 0;
                  return (
                    ctx.label +
                    ": " +
                    val +
                    " alunos (" +
                    perc.toFixed(1).replace(".", ",") +
                    "%)"
                  );
                },
              },
            },
          },
          onClick: (evt, elements) => {
            if (!elements.length) return;
            const index = elements[0].index;
            const label = labels[index];
            setFilter(label);
          },
        },
      });
    }

    function renderFilterButtons(counts) {
      const container = document.getElementById("filterButtons");
      container.innerHTML = "";

      function createBtn(label, filterValue) {
        const btn = document.createElement("button");
        btn.className =
          "filter-btn" +
          (filterValue === currentFilter ? " active" : "");
        btn.textContent = label;
        btn.dataset.filter = filterValue;
        return btn;
      }

      // Vis√£o ativa (padr√£o)
      container.appendChild(createBtn("Vis√£o ativa (Ativo + Aten√ß√£o)", "VisaoAtiva"));
      // Todos
      container.appendChild(createBtn("Todos", "Todos"));

      // Demais grupos que existem
      ["Ativo", "Aten√ß√£o CS", "Finalizado / Encerrado", "Vit√≥ria", "Outros"].forEach(
        (g) => {
          if (counts[g] > 0) {
            container.appendChild(createBtn(g, g));
          }
        }
      );

      container.addEventListener("click", (e) => {
        const btn = e.target.closest(".filter-btn");
        if (!btn) return;
        setFilter(btn.dataset.filter);
      });
    }

    function setFilter(filterValue) {
      currentFilter = filterValue;
      // atualizar estado visual dos bot√µes
      document
        .querySelectorAll(".filter-btn")
        .forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.filter === filterValue);
        });
      // redesenhar tabela
      renderTable();
    }

    /************************************************************
     * CARGA E PROCESSAMENTO DO CSV
     ************************************************************/
    function parseCSV() {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          document.getElementById("chartLoading").style.display = "none";

          const rows = results.data || [];
          if (!rows.length) {
            const err = document.getElementById("chartError");
            err.style.display = "block";
            err.textContent = "Nenhum dado encontrado no CSV.";
            return;
          }

          rawRows = rows;
          const columns = Object.keys(rows[0]);

          statusColumnName = guessColumnName(columns, POSSIBLE_STATUS_COLUMNS);
          nameColumnName = guessColumnName(columns, POSSIBLE_NAME_COLUMNS);

          if (!statusColumnName) {
            const err = document.getElementById("chartError");
            err.style.display = "block";
            err.textContent =
              "N√£o encontrei a coluna de STATUS no CSV. Ajuste os nomes em POSSIBLE_STATUS_COLUMNS no topo do c√≥digo.";
            return;
          }

          if (!nameColumnName) {
            nameColumnName = columns[0];
          }

          // Contagem por grupo
          const statusCounts = {
            "Ativo": 0,
            "Aten√ß√£o CS": 0,
            "Finalizado / Encerrado": 0,
            "Vit√≥ria": 0,
            "Outros": 0,
          };
          let total = 0;

          rows.forEach((row) => {
            const st = row[statusColumnName];
            if (!st) return;
            const group = classifyStatus(st);
            if (!statusCounts[group] && statusCounts[group] !== 0) {
              statusCounts[group] = 0;
            }
            statusCounts[group]++;
            total++;
          });

          // Resumo
          updateSummary(statusCounts, total);

          // Cabe√ßalho da tabela
          buildTableHead(columns);

          // Tabela inicial (Vis√£o ativa)
          renderTable();

          // Gr√°fico
          renderChart(statusCounts);

          // Filtros
          renderFilterButtons(statusCounts);
        },
        error: function (err) {
          document.getElementById("chartLoading").style.display = "none";
          const el = document.getElementById("chartError");
          el.style.display = "block";
          el.textContent = "Erro ao carregar CSV: " + (err.message || err);
        },
      });
    }

    // In√≠cio
    parseCSV();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Vendas - GO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- PapaParse para ler o CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #f5f5f7;
      --bg-card: #ffffff;
      --primary: #1f2933;
      --primary-soft: #e5e7eb;
      --accent: #6366f1;
      --accent-soft: #eef2ff;
      --text: #111827;
      --text-soft: #6b7280;
      --border: #e5e7eb;
      --radius-lg: 14px;
      --radius-md: 10px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.06);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top left, #eef2ff, #f9fafb 35%, #f3f4f6);
      color: var(--text);
      padding: 24px;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 24px;
      gap: 12px;
    }

    header .title-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    header h1 {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: 0.02em;
    }

    header p {
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(99, 102, 241, 0.06);
      border: 1px solid rgba(99, 102, 241, 0.3);
      font-size: 0.75rem;
      color: var(--accent);
      font-weight: 500;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    .layout {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap: 18px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    /* Filtros */
    .filters-card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      padding: 16px 14px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .filters-header h2 {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--primary);
    }

    .filters-header span {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 10px;
    }

    .filter-label {
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--text-soft);
    }

    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 9px;
      border: 1px solid var(--border);
      background-color: #fff;
      font-size: 0.8rem;
      color: var(--text);
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.06s ease;
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 14px) calc(50% - 3px), calc(100% - 9px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.3);
      transform: translateY(-1px);
    }

    .filters-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 6px;
    }

    button.btn-reset {
      border: none;
      background: transparent;
      font-size: 0.75rem;
      color: var(--accent);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 6px;
      border-radius: 999px;
      transition: background 0.15s ease, transform 0.06s ease;
    }

    button.btn-reset:hover {
      background: rgba(99, 102, 241, 0.06);
      transform: translateY(-1px);
    }

    /* Painel principal */
    .main-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      padding: 16px 16px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* KPIs */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 900px) {
      .kpi-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 600px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }
    }

    .kpi-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(209, 213, 219, 0.9);
      padding: 10px 10px;
      background: linear-gradient(135deg, #f9fafb, #ffffff);
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
      overflow: hidden;
    }

    .kpi-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(99, 102, 241, 0.08), transparent 55%);
      pointer-events: none;
    }

    .kpi-label {
      font-size: 0.75rem;
      color: var(--text-soft);
      font-weight: 500;
    }

    .kpi-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: 0.01em;
    }

    .kpi-sub {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    /* Tabela */
    .table-wrapper {
      margin-top: 4px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(209, 213, 219, 0.9);
      overflow: hidden;
      background: #ffffff;
    }

    .table-header {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .table-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .table-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--primary);
    }

    .table-subtitle {
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      font-size: 0.7rem;
      color: var(--accent);
    }

    .table-container {
      max-height: 460px;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      min-width: 600px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
    }

    thead tr {
      background: #f3f4f6;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-size: 0.74rem;
      font-weight: 600;
      color: #4b5563;
      position: relative;
    }

    tbody tr:nth-child(even) td {
      background: #fafafa;
    }

    tbody tr:hover td {
      background: #eef2ff;
    }

    .loading,
    .error-msg {
      font-size: 0.8rem;
      color: var(--text-soft);
      padding: 10px;
    }

    .error-msg {
      color: #b91c1c;
      background: #fef2f2;
      border-radius: 8px;
      border: 1px solid #fecaca;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title-block">
        <div class="badge">
          <span class="badge-dot"></span>
          <span>Dash de Vendas – CSV GO</span>
        </div>
        <h1>Visão de Vendas & Churn</h1>
        <p>
          Dados carregados diretamente da aba <strong>VENDAS</strong> (Google Sheets CSV). Use os filtros ao lado para
          analisar por mês de churn, cliente e acompanhar a oportunidade total por aluno (coluna N).
        </p>
      </div>
    </header>

    <div class="layout">
      <!-- FILTROS -->
      <aside class="filters-card">
        <div class="filters-header">
          <div>
            <h2>Filtros</h2>
            <span>Refine a visão da dash</span>
          </div>
        </div>

        <div class="filter-group" id="filter-mes-churn-group">
          <label for="filter-mes-churn" class="filter-label">Mês do churn</label>
          <select id="filter-mes-churn">
            <option value="">Todos os meses</option>
          </select>
        </div>

        <div class="filter-group" id="filter-cliente-group">
          <label for="filter-cliente" class="filter-label">Cliente</label>
          <select id="filter-cliente">
            <option value="">Todos os clientes</option>
          </select>
        </div>

        <div class="filters-actions">
          <button type="button" class="btn-reset" id="btn-reset">
            <span>↺</span>
            <span>Limpar filtros</span>
          </button>
        </div>
      </aside>

      <!-- CONTEÚDO PRINCIPAL -->
      <main class="main-card">
        <!-- KPIs -->
        <section class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-label">Oportunidade total por aluno (filtrado)</div>
            <div class="kpi-value" id="kpi-oportunidade-por-aluno">R$ 0,00</div>
            <div class="kpi-sub">Soma da coluna N (apenas linhas visíveis)</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Quantidade de vendas</div>
            <div class="kpi-value" id="kpi-qtd-vendas">0</div>
            <div class="kpi-sub">Total de registros após os filtros</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Clientes únicos</div>
            <div class="kpi-value" id="kpi-clientes-unicos">0</div>
            <div class="kpi-sub">Baseado na coluna "Cliente"</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Mês do churn selecionado</div>
            <div class="kpi-value" id="kpi-mes-churn">Todos</div>
            <div class="kpi-sub">Reflete o filtro aplicado</div>
          </div>
        </section>

        <!-- TABELA -->
        <section class="table-wrapper">
          <div class="table-header">
            <div class="table-header-left">
              <span class="table-title">Registros detalhados</span>
              <span class="table-subtitle">
                Visualização linha a linha dos dados da aba VENDAS, após aplicação dos filtros.
              </span>
            </div>
            <span class="pill">
              <span style="width:6px;height:6px;border-radius:999px;background:#22c55e;"></span>
              <span id="pill-registros">0 registros</span>
            </span>
          </div>
          <div class="table-container" id="table-container">
            <div class="loading">Carregando dados do CSV...</div>
          </div>
        </section>

        <div id="error-container"></div>
      </main>
    </div>
  </div>

  <script>
    // URL do CSV da aba VENDAS
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjsb8vTeRq4sfWIccUpEwy55opckva5oZwJZqQ_XnUYKQJDHgmnL9buW_gZFAIZgoIeMN49t6l0pul/pub?gid=1865445107&single=true&output=csv";

    // Estado
    let originalData = [];
    let filteredData = [];
    let headerFields = [];

    let mesChurnFieldName = null;
    let clienteFieldName = null;
    let oportunidadeAlunoFieldName = null; // coluna N (posição 13)

    const mesChurnSelect = document.getElementById("filter-mes-churn");
    const clienteSelect = document.getElementById("filter-cliente");
    const resetButton = document.getElementById("btn-reset");
    const tableContainer = document.getElementById("table-container");
    const errorContainer = document.getElementById("error-container");

    const kpiOportunidade = document.getElementById("kpi-oportunidade-por-aluno");
    const kpiQtdVendas = document.getElementById("kpi-qtd-vendas");
    const kpiClientesUnicos = document.getElementById("kpi-clientes-unicos");
    const kpiMesChurn = document.getElementById("kpi-mes-churn");
    const pillRegistros = document.getElementById("pill-registros");

    // Utilitário: converte string com vírgula/ponto para número
    function toNumber(value) {
      if (value === null || value === undefined) return 0;
      let v = String(value).trim();
      if (!v) return 0;

      // Remove espaços e símbolos comuns
      v = v.replace(/\s/g, "").replace(/R\$/gi, "");

      // Troca ponto de milhar e vírgula de decimal
      // Ex: 1.234,56 -> 1234.56 | 1234,56 -> 1234.56
      v = v.replace(/\./g, "").replace(",", ".");

      const num = parseFloat(v);
      return isNaN(num) ? 0 : num;
    }

    // Formata número em moeda BR
    function formatCurrencyBR(value) {
      return value.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL",
        maximumFractionDigits: 2,
      });
    }

    // Carrega CSV
    function loadCSV() {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          try {
            headerFields = results.meta.fields || [];
            originalData = (results.data || []).filter((row) => {
              // filtra linhas totalmente vazias
              return Object.values(row).some((v) => String(v || "").trim() !== "");
            });

            if (!headerFields.length || !originalData.length) {
              throw new Error("Não foi possível carregar dados válidos do CSV.");
            }

            detectFieldNames();
            buildFilterOptions();
            applyFilters(); // primeira renderização
          } catch (err) {
            showError(err.message || "Erro ao processar o CSV.");
          }
        },
        error: function (err) {
          showError("Erro ao carregar o CSV: " + (err?.message || "desconhecido"));
        },
      });
    }

    // Detecta nomes das colunas importantes
    function detectFieldNames() {
      // Mês do churn - procura por variações
      mesChurnFieldName =
        headerFields.find((name) => {
          if (!name) return false;
          const n = name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
          return (
            n.includes("mes do churn") ||
            n.includes("mes_churn") ||
            n.includes("mes churn") ||
            n.includes("mes_churn") ||
            n.includes("mes_churn")
          );
        }) || null;

      // Cliente
      clienteFieldName =
        headerFields.find((name) => {
          if (!name) return false;
          const n = name.toLowerCase();
          return n.includes("cliente");
        }) || null;

      // Coluna N (posição 13)
      if (headerFields.length > 13) {
        oportunidadeAlunoFieldName = headerFields[13]; // índice 13 => coluna N
      } else {
        oportunidadeAlunoFieldName = null;
      }
    }

    // Monta opções dos filtros (Mês do churn e Cliente)
    function buildFilterOptions() {
      // Mês do churn
      if (mesChurnFieldName) {
        const setMes = new Set();
        originalData.forEach((row) => {
          const v = (row[mesChurnFieldName] || "").toString().trim();
          if (v) setMes.add(v);
        });

        const valores = Array.from(setMes).sort(); // ordenação lexicográfica - bom para AAAA-MM
        valores.forEach((v) => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          mesChurnSelect.appendChild(opt);
        });
      } else {
        // desabilita se não encontrar
        mesChurnSelect.innerHTML = '<option value="">(Coluna "Mês do churn" não encontrada)</option>';
        mesChurnSelect.disabled = true;
      }

      // Cliente
      if (clienteFieldName) {
        const setClientes = new Set();
        originalData.forEach((row) => {
          const v = (row[clienteFieldName] || "").toString().trim();
          if (v) setClientes.add(v);
        });

        const valores = Array.from(setClientes).sort((a, b) =>
          a.localeCompare(b, "pt-BR", { sensitivity: "base" })
        );
        valores.forEach((v) => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          clienteSelect.appendChild(opt);
        });
      } else {
        clienteSelect.innerHTML = '<option value="">(Coluna "Cliente" não encontrada)</option>';
        clienteSelect.disabled = true;
      }
    }

    // Aplica filtros sobre originalData
    function applyFilters() {
      const selectedMes = mesChurnSelect.disabled ? "" : mesChurnSelect.value;
      const selectedCliente = clienteSelect.disabled ? "" : clienteSelect.value;

      filteredData = originalData.filter((row) => {
        let ok = true;

        if (selectedMes && mesChurnFieldName) {
          const valorMes = (row[mesChurnFieldName] || "").toString().trim();
          if (valorMes !== selectedMes) ok = false;
        }

        if (selectedCliente && clienteFieldName) {
          const valorCli = (row[clienteFieldName] || "").toString().trim();
          if (valorCli !== selectedCliente) ok = false;
        }

        return ok;
      });

      renderTable();
      updateKpis(selectedMes);
    }

    // Atualiza KPIs
    function updateKpis(selectedMes) {
      // Oportunidade total por aluno (coluna N)
      let totalOportunidadeAluno = 0;
      if (oportunidadeAlunoFieldName) {
        filteredData.forEach((row) => {
          totalOportunidadeAluno += toNumber(row[oportunidadeAlunoFieldName]);
        });
      }

      // Quantidade de vendas (linhas filtradas)
      const qtdVendas = filteredData.length;

      // Clientes únicos
      let qtdClientesUnicos = 0;
      if (clienteFieldName) {
        const setCli = new Set();
        filteredData.forEach((row) => {
          const v = (row[clienteFieldName] || "").toString().trim();
          if (v) setCli.add(v);
        });
        qtdClientesUnicos = setCli.size;
      }

      kpiOportunidade.textContent = formatCurrencyBR(totalOportunidadeAluno);
      kpiQtdVendas.textContent = qtdVendas.toString();
      kpiClientesUnicos.textContent = qtdClientesUnicos.toString();
      kpiMesChurn.textContent = selectedMes || "Todos";
      pillRegistros.textContent = `${qtdVendas} registro${qtdVendas === 1 ? "" : "s"}`;
    }

    // Renderiza tabela com dados filtrados
    function renderTable() {
      if (!filteredData.length) {
        tableContainer.innerHTML =
          '<div class="loading">Nenhum registro encontrado com os filtros atuais.</div>';
        return;
      }

      // Cabeçalho
      let theadHtml = "<thead><tr>";
      headerFields.forEach((h) => {
        theadHtml += `<th>${h || ""}</th>`;
      });
      theadHtml += "</tr></thead>";

      // Corpo
      let tbodyHtml = "<tbody>";
      filteredData.forEach((row) => {
        tbodyHtml += "<tr>";
        headerFields.forEach((h) => {
          let v = row[h];
          if (v === null || v === undefined) v = "";
          tbodyHtml += `<td>${String(v)}</td>`;
        });
        tbodyHtml += "</tr>";
      });
      tbodyHtml += "</tbody>";

      tableContainer.innerHTML = `<table>${theadHtml}${tbodyHtml}</table>`;
    }

    function showError(msg) {
      tableContainer.innerHTML = "";
      errorContainer.innerHTML = `<div class="error-msg">${msg}</div>`;
    }

    // Eventos
    mesChurnSelect.addEventListener("change", applyFilters);
    clienteSelect.addEventListener("change", applyFilters);
    resetButton.addEventListener("click", () => {
      if (!mesChurnSelect.disabled) mesChurnSelect.value = "";
      if (!clienteSelect.disabled) clienteSelect.value = "";
      applyFilters();
    });

    // Inicialização
    document.addEventListener("DOMContentLoaded", loadCSV);
  </script>
</body>
</html>
